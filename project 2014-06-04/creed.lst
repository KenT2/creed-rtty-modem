MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE  1


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00001         LIST    P=16f876
                      00002         ERRORLEVEL      -302    ; suppress message 302 from listing
                      00003 
                      00004         include <p16f876.inc>
                      00001         LIST
                      00002 
                      00003 ;==========================================================================
                      00004 ;  MPASM PIC16F876 processor include
                      00005 ; 
                      00006 ;  (c) Copyright 1999-2011 Microchip Technology, All rights reserved
                      00007 ;==========================================================================
                      00008 
                      00496         LIST
                      00005 
                      00006 
                      00007 #define true    0xFF
                      00008 #define false   0x00
                      00009 
                      00010 #define usingdebugger   false
                      00011 
                      00012  if usingdebugger
                      00013 
                      00014  __CONFIG _XT_OSC& _WDT_OFF&_PWRTE_OFF&_BODEN_OFF&_LVP_OFF&_CPD_OFF&_WRT_ENABLE_ON&_DEBUG_ON&_CP_OFF
                      00015 
                      00016 ;                     osc             watchdog        power up timer    brown out      low volt prog    
                            data EE protect      flash write enable    ICD use pins      code protect
                      00017  else
                      00018 
2007   3F39           00019  __CONFIG _XT_OSC& _WDT_OFF&_PWRTE_OFF&_BODEN_OFF&_LVP_OFF&_CPD_OFF&_WRT_ENABLE_ON&_DEBUG_OFF&_CP_OFF
                      00020 
                      00021  endif
                      00022 
                      00023 ;FILE REGISTERS
                      00024 
                      00025         include <creedvars.inc>
                      00001 ; TO DO
                      00002 
                      00003 
                      00004 
                      00005 ; User Set Constants
                      00006 
                      00007 ; DON'T CHANGE ANYTHING AFTER THIS
                      00008 
                      00009 
                      00010 
                      00011 
                      00012 ;MENU STATES
                      00013  #define        menu_off        0       ;not in a menu
                      00014  #define        menu_sets       1       ;display settngs
                      00015  #define        menu_1  2       ;in top level menu
                      00016  #define        menu_2  3       ; in a second level menu
                      00017  #define        menu_fini       4       ;DISpLAYING FINISHED MESSAGE
                      00018  #define        menu_err        5       ;not really a menu stae but used to stop transfers when displayi
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE  2


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                            ng error messages
                      00019  
                      00020 
                      00021 ; Timer control constants
  0000001C            00022 tick_counter_period     set     .28     ; approx 700mS in 25mS steps
                      00023 
                      00024 
                      00025 ;; Port A
                      00026 #define tx_bit  0       ;input
                      00027 #define inok_bit        1       ; input
                      00028 #define next_bit        2       ; input
                      00029 ; bits 3 - 5 not used
                      00030 
                      00031 ;; PORT B
                      00032 #define demod_lock_bit  0       ; input
                      00033 #define mod_data_bit    1       ; output
                      00034 #define creed_printer_data_bit  2       ; output
                      00035 #define creed_motor_bit 3       ; output
                      00036 #define demod_data_bit  4       ; input
                      00037 #define creed_kb_data_bit       5       ; input
                      00038 
                      00039 ;; PORT C
                      00040 
                      00041 #define lcd_enable_bit  4       ; output
                      00042 #define lcd_reg_sel_bit 5       ; output
                      00043 #define uart_tx_bit             6       ; set as input but not used
                      00044 #define uart_rx_bit             7       ; set as input but not used     
                      00045 
                      00046 #define LCD_RS  PORTC, 5        ; 0 = Command, 1 = Data
                      00047 #define LCD_E   PORTC, 4        ; 1 to send data
                      00048 
                      00049 ;EEPROM locations. Second level menus must be in this order
                      00050 #define EEmode  0       ; transfer mode
                      00051 #define EETUbaud        1       ; baud rate of modulatro/demodulator
                      00052 #define EETUreverse     2       ; true = TU  reversed frequency
                      00053 #define EEPCcrlf        3       
                      00054 #define EEdiddles       4
                      00055 #define EEautostart     5
                      00056 #define EEUSOS  6
                      00057 
                      00058 ;; VARIABLES IN RAM
                      00059         cblock  h'20'
                      00060 
                      00061 ; CONDITIONED DIGITAL INPUTS
                      00062 
                      00063 ;Tx/Rx
  00000020            00064 tx              ;true if the Tx switch is in Tx position
                      00065         
                      00066 ; USART
  00000021            00067 usart_rx_data           ; character transferred from hardware
  00000022            00068 usart_rx_data_full      ; set if there is a character available
  00000023            00069 usart_tx_data           ;data to tansmit to hardware
  00000024            00070 usart_tx_data_full      ; set if there is a character to transmit
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE  3


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

  00000025            00071 usart_write_pointer             ;write pointer for 16 character buffer
  00000026            00072 usart_read_pointer              ;read pointer for 16 character buffer
  00000027            00073 usartchar1              ;temp
  00000028            00074 usartchar2              ;temp
                      00075 
                      00076 ;MENU BUTTONS
  00000029            00077 menu_inok_pressed       ; inok button is pressed
  0000002A            00078 last_menu_inok  ; previous state of inok for producing signal
  0000002B            00079 menu_inok_signal        ; signal produced when button is pressed
  0000002C            00080 menu_next_pressed
  0000002D            00081 last_menu_next  ; previous state of inok for producing signal
  0000002E            00082 menu_next_signal        ; signal produced when button is pressed
                      00083 
                      00084 ;MENU CONTROL
  0000002F            00085 menu_state              ;state of menu
                      00086                 ;0 - not in menu, used to enable/inhibit transfer modes
                      00087                 ;1 - displaying software version
                      00088                 ;2 - in top level menu
                      00089                 ;3 - in second level menu
                      00090                 ;4 - displaying the set/restart message
                      00091                 
  00000030            00092 cur_2_menu_h    ;address of current second level menu
  00000031            00093 cur_2_menu_l
  00000032            00094 menu_result_index       ; which top level menu we are in - used to store the result
                      00095 
                      00096 
  00000033            00097 eewriteaddress  ;EEPROM write arguement to EEwrite
                      00098 
                      00099 
                      00100 ;SYSTEM CONFIGURATON
                      00101 ; these configure the operation of the system, they are set from EEPROM at power on
                      00102 ; and can be changed by the menu
                      00103 ; the variables must be in the same order as the top level menu items
                      00104 ; as they are indexed by menu_result_index.
  00000034            00105 mode            ; transfer mode
                      00106                 ; 0 - weather
                      00107                 ; 1 - TU to Creed
                      00108                 ; 2 - TU to PC
                      00109                 ; 3 - PC to Creed
                      00110                 ; 4 - Creed Loop
                      00111                 ; 5 - TU Loop
                      00112                 ; 6 - PC Loop
                      00113                 
  00000035            00114 baud_rate               ; 45,50, 75 or 100 baud rate of TU
  00000036            00115 TUreverse               ; R - If True upper and lower shift frequencies are reversed
  00000037            00116 PCcrlf          ; C - if true a CR is inserted before a  LF when receiving data from PC
  00000038            00117 diddles         ; D - if true then diddles fill empty transmission slots
  00000039            00118 autostart               ; S - if true then only turn Creed motor on if signal is locked
  0000003A            00119 USOS            ; U - Unshift on Space. If true then letters shift is sent to the modulator before every
                             word.
                      00120 
                      00121 ;TU - modulator/demodulator
                      00122 
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE  4


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00123 ;  Bitbang I/O file register variables & buffers
  0000003B            00124 TUTXWORK              ; TX ISR work byte (isr)
  0000003C            00125 TURXWORK             ; RX ISR work byte (isr)
  0000003D            00126 TUTX_SM              ; TX state machine var (isr)
  0000003E            00127 TURX_SM             ; RX state machine var (isr)
                      00128 
  0000003F            00129 timer1_h                ;interrupt period for TU bitbang
  00000040            00130 timer1_l
  00000041            00131 tu_mod_data             ; the one character buffer used by the routine that send data to the bitbang
  00000042            00132 tu_mod_data_full
  00000043            00133 tumb_write_pointer      ;write pointer for 16 character buffer
  00000044            00134 tumb_read_pointer       ;read pointer for 16 character buffer
  00000045            00135 tu_mod_shift            ;current shift sent to  the TU modulator
  00000046            00136 tu_demod_shift  ;current shift of TU demodulator
  00000047            00137 tu_demod_data   ;data received from demodulator
  00000048            00138 tu_demod_data_full              
  00000049            00139 tu_lock         ;records last 8 TU demodulator lock samples, TU considered locked if all 8 are 1.
  0000004A            00140 tu_lock_state           ;state machine for creed motor control from lock for autostart
                      00141                 ; 0 - motor off
                      00142                 ; 1 - to locked
                      00143                 ; 2 - executing motor turn off delay (1 second)
  0000004B            00144 tuchar1                 ;temp
  0000004C            00145 tuchar2                 ;temp
                      00146 
                      00147 ;CREED
                      00148 ;  Bitbang I/O file register variables & buffers
  0000004D            00149 CRTXWORK              ; TX ISR work byte (isr)
  0000004E            00150 CRRXWORK             ; RX ISR work byte (isr)
  0000004F            00151 CRTX_SM              ; TX state machine var (isr)
  00000050            00152 CRRX_SM             ; RX state machine var (isr)
                      00153 
  00000051            00154 creed_printer_data      ; the one character buffer used by the routine that send data to the bitbang
  00000052            00155 creed_printer_data_full
  00000053            00156 cpb_write_pointer               ;write pointer for 16 character buffer
  00000054            00157 cpb_read_pointer                ;read pointer for 16 character buffer
                      00158 
  00000055            00159 creedchar1              ;temp
  00000056            00160 creedchar2              ;temp
                      00161 
  00000057            00162 creed_kb_data   ; keyboard buffer
  00000058            00163 creed_kb_data_full
  00000059            00164 creed_kb_shift  ;shift last received from creed KB
  0000005A            00165 creed_printer_shift     ;the shift last sent to the creed printer F or  L
                      00166 
                      00167 
                      00168 ;LCD
  0000005B            00169 LCDpos  ;LCD position for scrolling
  0000005C            00170 LCDbyte ; holds byte when sending nibbles
                      00171 
                      00172 
                      00173 ; TABLES IN PROGRAM MEMORY
                      00174 ; parameters of readflash routine
  0000005D            00175 tblptr_l        ;table pointer
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE  5


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

  0000005E            00176 tblptr_h        ;table pointer
  0000005F            00177 tblval_l        ;value taken from table
  00000060            00178 tblval_h        ;value taken from table 
                      00179 
                      00180 ; TIMERS
                      00181 ;;   timers - start at a positive number and increment to zero
                      00182 ;;   0 is the off value, the timers do not increment past zero
                      00183 ;;    incremented on either every 25ms or every 700mS.
                      00184 
                      00185 ;700mS timers
  00000061            00186 menu_timer              ;timer for entry set display.
                      00187 
                      00188 ;25mS timers
  00000062            00189 tu_lock_timer           ;timer for TU lock delay
  00000063            00190 tick_counter            ; tick counter counts to 700mS in 25ms increments
                      00191 
                      00192 
                      00193 ;digital input buffer and de-bouncing (debounce port A only)
  00000064            00194 inbuf_a ; input buffer
  00000065            00195 inbuf_db_a      ; debounced input buffer
  00000066            00196 count_A_a       ; counter for debounce, port A
  00000067            00197 count_B_a       ; counter for debounce
  00000068            00198 changed_a       ; bits that have changed (true for one tick)
                      00199 
                      00200 
                      00201 ;temps for base level
                      00202 
                      00203 ; MODES
  00000069            00204 modes1
                      00205 
                      00206 ; CHARACTER CONVERSION
  0000006A            00207 cctemp1         ; temps for code conversion
  0000006B            00208 cctemp2
  0000006C            00209 cctemp3
  0000006D            00210 cctemp4
  0000006E            00211 cctemp5
  0000006F            00212 cc_temp_shift   ;shift arguement to Ccitoa - in and return
  00000070            00213 ITA2char                ;output of ascii to ITA2 conversion
                      00214 
                      00215 ; FOR DEBUG
                      00216 ; Int_delay             ;delay for debug in bitbang interrupt routines
                      00217 
                      00218         endc
                      00219 
                      00220 ; bank independent ram
                      00221         cblock  h'7b'
                      00222 
                      00223 ;interrupt stack - should be shared
  0000007B            00224 int_w
  0000007C            00225 int_status
  0000007D            00226 int_pclath
                      00227 ;interrupt routine variables - don't need to be shared
  0000007E            00228 int_pir1
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE  6


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

  0000007F            00229 int_pir2
                      00230 
                      00231 
                      00232         endc
                      00233         
                      00234 ; buffers in BANK1 can't be in Bank2 as not addressable there
00A0                  00235         org     h'A0'
00A0                  00236 creed_printer_buffer            ;16 word creed printer buffer
00B0                  00237         org     h'B0'   
00B0                  00238 usart_tx_buffer         ;16 word USART transmit buffer
00C0                  00239         org     h'C0'   
00C0                  00240 tu_mod_buffer           ;modulator Tx Buffer
                      00241 
                      00242 
                      00243 ; variables in Bank 2 - overflow from Bank0, mainly self contained subroutine local variables
                      00244         cblock  h'120'
                      00245         
                      00246 ; LCD timing delay counters     
  00000120            00247 LCDcount3
  00000121            00248 LCDcount2
  00000122            00249 LCDcount1
                      00250 
                      00251 ; multiply routine
  00000123            00252 resulthi
  00000124            00253 resultlo
                      00254         endc
                      00026 
                      00027 ;MACROS
                      00028 
                      00029 Bank0:  MACRO
                      00030         bcf STATUS, RP0
                      00031         bcf STATUS, RP1
                      00032         ENDM
                      00033         
                      00034 Bank1:  MACRO
                      00035         bsf STATUS, RP0
                      00036         bcf STATUS, RP1
                      00037         ENDM
                      00038         
                      00039 Bank2:  MACRO
                      00040         bcf STATUS, RP0
                      00041         bsf STATUS, RP1
                      00042         ENDM
                      00043         
                      00044         
                      00045 Bank3:  MACRO
                      00046         bsf STATUS, RP0
                      00047         bsf STATUS, RP1
                      00048         ENDM
                      00049 
                      00050 DoMark: MACRO
                      00051         bcf     PORTB,creed_printer_data_bit
                      00052         ENDM
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE  7


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00053 
                      00054 DoSpace:        MACRO
                      00055         bsf     PORTB,creed_printer_data_bit
                      00056         ENDM
                      00057 
                      00058 DoTUMark:       MACRO
                      00059         bcf     PORTB,mod_data_bit      
                      00060         ENDM
                      00061 
                      00062 DoTUSpace:MACRO
                      00063         bsf     PORTB,mod_data_bit
                      00064         ENDM
                      00065         
                      00066         
                      00067 Domotoroff:     MACRO
                      00068         bcf     PORTB,creed_motor_bit
                      00069         ENDM
                      00070 
                      00071 Domotoron:      MACRO
                      00072         bsf     PORTB,creed_motor_bit
                      00073         ENDM
                      00074 
                      00075 
                      00076 ;ADDRESSES OF DATA TABLES in Flash Program memory
                      00077 
  0000000A            00078 errcpbuf_h      set      errcpbuf/.256
  000000A5            00079 errcpbuf_l      set      errcpbuf & .255
                      00080 
  0000000A            00081 errTUbuf_h      set      errTUbuf/.256
  000000B5            00082 errTUbuf_l      set      errTUbuf & .255
                      00083 
  0000000A            00084 errurbuf_h      set      errurbuf/.256
  000000C5            00085 errurbuf_l      set      errurbuf & .255
                      00086 
  0000000A            00087 errutbuf_h      set      errutbuf/.256
  000000CF            00088 errutbuf_l      set      errutbuf & .255
                      00089 
  0000000A            00090 errmode_h       set      errmode/.256
  000000D9            00091 errmode_l       set      errmode & .255
                      00092 
  00000008            00093 topmenu_h       set      topmenu/.256
  00000020            00094 topmenu_l       set      topmenu & .255
                      00095         
  00000008            00096 versionstr_h    set      versionstr/.256
  00000000            00097 versionstr_l    set      versionstr & .255      
                      00098 
  00000008            00099 setstr_h        set      setstr/.256
  00000004            00100 setstr_l        set      setstr & .255
                      00101 
  00000008            00102 welstr_h        set      welstr/.256
  00000015            00103 welstr_l        set      welstr & .255
                      00104 
  00000009            00105 codeconvert_h   set     codeconvert/.256
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE  8


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

  00000025            00106 codeconvert_l   set     codeconvert & .255
                      00107 
                      00108 ; offsets for code conversion table
                      00109 #define cc_ascii        0       ;ascii value
                      00110 #define cc_shift        1       ; shift F,L,B,U
                      00111 #define cc_ita2 2       ; ITA2 character value
                      00112 
                      00113 
                      00114 ;; PROGRAM
00C0                  00115 Poweron 
0000                  00116         org     0000h   ; put code at RESET vector location
0000   2E31           00117         GOTO    ZMain
                      00118 
0001                  00119 Interrupt
0004                  00120         org     0004h   ; put code at interrupt vector location 
0004   2EC4           00121         GOTO    ZIntroutine
                      00122 
                      00123 ; MENU
                      00124 ;{
                      00125         
                      00126 ; uses the INOK and NEXT buttons to traverse the menus tree,
                      00127 ; stores result in the appropriate RAM location
                      00128 
                      00129 ;produce sinals from the buttons when a button is pressed and not when it is held down
                      00130 
0005                  00131 ZMenuinit
0005   3000           00132         movlw   0
0006   00AA           00133         movwf   last_menu_inok
0007   00AB           00134         movwf   menu_inok_signal
0008   00AD           00135         movwf   last_menu_next
0009   00AE           00136         movwf   menu_next_signal        
000A   00AF           00137         movwf   menu_state
000B   00B2           00138         movwf   menu_result_index
000C   0008           00139         return
                      00140 
                      00141 
000D   0829           00142 ZMenu   movfw   menu_inok_pressed
000E   022A           00143         subwf   last_menu_inok,w
000F   1903 2816      00144         bz      Conditioninokend        ; no change - escape
                      00145 
0011   0829           00146         movfw   menu_inok_pressed
0012   1903 2816      00147         bz      Conditioninokend        ; end of pulse, do nothing
                      00148         
                      00149                                 ; else produce inok signal
0014   30FF           00150         movlw   true
0015   00AB           00151         movwf   menu_inok_signal
                      00152 
0016                  00153 Conditioninokend
                      00154 
0016   0829           00155         movfw   menu_inok_pressed
0017   00AA           00156         movwf   last_menu_inok
                      00157         
                      00158 ; deal with next
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE  9


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0018   082C           00159         movfw   menu_next_pressed
0019   022D           00160         subwf   last_menu_next,w
001A   1903 2821      00161         bz      Conditionnextend        ; no change - escape
                      00162 
001C   082C           00163         movfw   menu_next_pressed
001D   1903 2821      00164         bz      Conditionnextend        ; end of pulse, do nothing
                      00165         
                      00166                                 ; else produce inok signal
001F   30FF           00167         movlw   true
0020   00AE           00168         movwf   menu_next_signal
                      00169 
0021                  00170 Conditionnextend
0021   082C           00171         movfw   menu_next_pressed
0022   00AD           00172         movwf   last_menu_next
                      00173 
                      00174 ; now do the menu state machine using the signals
                      00175         
0023   082F           00176         movfw   menu_state
0024   1903 2832      00177         bz      menu0   ;not in menu
0026   3C01           00178         sublw   .1
0027   1903 2849      00179         bz      menu1   ;in displaying configuration data state
0029   082F           00180         movfw   menu_state
002A   3C02           00181         sublw   .2
002B   1903 2850      00182         bz      menu2   ;in top level menu state
002D   082F           00183         movfw   menu_state
002E   3C03           00184         sublw   .3
002F   1903 286E      00185         bz      menu3   ;in second level menu
0031   2890           00186         goto    menu4   ;finishing
                      00187         
                      00188 ; STATE 0, not in a menu        
0032   082E           00189 menu0   movfw   menu_next_signal
0033   1D03 2839      00190         bnz     menu01          ;display config data
0035   082B           00191         movfw   menu_inok_signal
0036   1D03 283E      00192         bnz     menu02  ;enter top level menu
0038   289B           00193         goto    menuend
                      00194 
                      00195 ; display the configuration
0039   2237           00196 menu01  call    LCDstatic
003A   3001           00197         movlw   menu_sets               ;set menu state
003B   00AF           00198         movwf   menu_state
003C   28B2           00199         goto    showconfig              ;use goto not call because of stack overflow
003D   2898           00200         goto    menusigreset
                      00201 
                      00202                 
                      00203 ;  enter top level menu from no menu or from displaying settings
003E   2237           00204 menu02  call    LCDstatic
003F   3002           00205         movlw   menu_1  ;set state to in top level menu
0040   00AF           00206         movwf   menu_state
0041   3000           00207 menu03  movlw   .0      ;init the index used to store the result
0042   00B2           00208         movwf   menu_result_index
0043   3008           00209         movlw   topmenu_h       ;display the first entry
0044   00DE           00210         movwf   tblptr_h
0045   3020           00211         movlw   topmenu_l
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 10


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0046   00DD           00212         movwf   tblptr_l
0047   2225           00213         call    LCDstr
0048   2898           00214         goto    menusigreset
                      00215 
                      00216 
                      00217 ;STATE1, currently displaying settings
0049   082E           00218 menu1   movfw   menu_next_signal
004A   1D03 2894      00219         bnz     menuexit                ;clear settings and exit menu
004C   082B           00220         movfw   menu_inok_signal
004D   1D03 283E      00221         bnz     menu02          ;enter top level menu
004F   289B           00222         goto    menuend
                      00223         
                      00224 
                      00225 ; STATE 2 - in top level menu
0050   082E           00226 menu2   movfw   menu_next_signal
0051   1D03 2857      00227         bnz     menu21  ; next menu item
0053   082B           00228         movfw   menu_inok_signal
0054   1D03 2860      00229         bnz     menu22  ;enter second level menu
0056   289B           00230         goto    menuend
                      00231 
                      00232 
                      00233 ; move to next entry in top level menu
0057   21D5           00234 menu21  call    Inctblptr       ;move to value
0058   21D5           00235         call    Inctblptr       ;move to first character of next entry
0059   21B6           00236         call    Readflash       ;get first char of next entry
005A   085F           00237         movfw   tblval_l        ;is it a null string?
005B   1903 2841      00238         bz      menu03  ;yes- got to start of menu
005D   0AB2           00239         incf    menu_result_index,f     ; no  - increment pointer to store result
005E   2225           00240         call    LCDstr  ;and show the menu item
005F   2898           00241         goto    menusigreset
                      00242 
                      00243 ; enter level 2 menu
0060   21D5           00244 menu22  call    Inctblptr       ;move to value
0061   21B6           00245         call    Readflash       ;address of second level menu
0062   0860           00246         movfw   tblval_h        ;save it for the future
0063   00B0           00247         movwf   cur_2_menu_h
0064   085F           00248         movfw   tblval_l
0065   00B1           00249         movwf   cur_2_menu_l
0066   0830           00250 menu23  movfw   cur_2_menu_h    ;display first entry
0067   00DE           00251         movwf   tblptr_h
0068   0831           00252         movfw   cur_2_menu_l
0069   00DD           00253         movwf   tblptr_l                
006A   2225           00254         call    LCDstr  ; display first entry
006B   3003           00255         movlw   menu_2
006C   00AF           00256         movwf   menu_state
006D   2898           00257         goto    menusigreset
                      00258 
                      00259 ; STATE 3 - in second level menu
006E   082E           00260 menu3   movfw   menu_next_signal
006F   1D03 2875      00261         bnz     menu31  ; next menu item
0071   082B           00262         movfw   menu_inok_signal
0072   1D03 287D      00263         bnz     menu32  ;value selected - get value
0074   289B           00264         goto    menuend
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 11


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00265 
                      00266 ; move to next entry in second level menu
0075   21D5           00267 menu31  call    Inctblptr       ;move to value
0076   21D5           00268         call    Inctblptr       ;move to first character of next entry
0077   21B6           00269         call    Readflash       ;get first char of next entry
0078   085F           00270         movfw   tblval_l        ;is it a null string?
0079   1903 2866      00271         bz      menu23  ;yes- got to start of menu
007B   2225           00272         call    LCDstr  ;no so show the menu item
007C   2898           00273         goto    menusigreset
                      00274 
                      00275 ; get value and return
007D   21D5           00276 menu32  call    Inctblptr       ;move to value
007E   21B6           00277         call    Readflash       ;get value to be changed
007F   0860           00278         movfw   tblval_h        ; is value greater than ff
0080   1D03 2894      00279         bnz     menuexit        ;yes exit menu without saving anything
0082   0832           00280         movfw   menu_result_index       ;get index to variable being changed
0083   00B3           00281         movwf   eewriteaddress
0084   085F           00282         movfw   tblval_l                ;get result
0085   210E           00283         call    ZEEwrite
0086   3008           00284         movlw   setstr_h                ;display set message on LCD
0087   00DE           00285         movwf   tblptr_h
0088   3004           00286         movlw   setstr_l
0089   00DD           00287         movwf   tblptr_l
008A   2225           00288         call    LCDstr
008B   3004           00289         movlw   menu_fini
008C   00AF           00290         movwf   menu_state
008D   3003           00291         movlw   .3      ;display message for 3 seconds
008E   00E1           00292         movwf   menu_timer
008F   2898           00293         goto    menusigreset
                      00294 
0090   0861           00295 menu4   movfw   menu_timer              ;delay finished?
0091   1D03 289B      00296         bnz     menuend 
0093   2E31           00297         goto    ZMain           ; yes so restart the program for setting to take effect
                      00298 
                      00299 ;next pressed and others - exit menu    
0094   3000           00300 menuexit        movlw   menu_off        ;set menu state to off
0095   00AF           00301         movwf   menu_state
0096   223B           00302         call    LCDscroll       ;init LCD scrolling 
0097   2898           00303         goto    menusigreset
                      00304 
                      00305         
0098                  00306 menusigreset
0098   3000           00307         movlw   .0
0099   00AE           00308         movwf   menu_next_signal
009A   00AB           00309         movwf   menu_inok_signal        
                      00310 
009B   0008           00311 menuend return
                      00312 
                      00313                 
                      00314 ;}
                      00315 
                      00316 ;CONFIGURATION DATA
                      00317 ;{
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 12


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00318 
                      00319 ; read configuration data from the EEPROM
009C                  00320 ZReadconfig
009C   3000           00321         movlw   EEmode
009D   2101           00322         call    ZEEread
009E   00B4           00323         movwf   mode
                      00324         
009F   3001           00325         movlw   EETUbaud
00A0   2101           00326         call    ZEEread
00A1   00B5           00327         movwf   baud_rate
                      00328 
00A2   3002           00329         movlw   EETUreverse
00A3   2101           00330         call    ZEEread
00A4   00B6           00331         movwf   TUreverse       
                      00332         
00A5   3003           00333         movlw   EEPCcrlf
00A6   2101           00334         call    ZEEread
00A7   00B7           00335         movwf   PCcrlf
                      00336         
00A8   3004           00337         movlw   EEdiddles
00A9   2101           00338         call    ZEEread
00AA   00B8           00339         movwf   diddles
                      00340         
00AB   3005           00341         movlw   EEautostart
00AC   2101           00342         call    ZEEread
00AD   00B9           00343         movwf   autostart
                      00344         
00AE   3006           00345         movlw   EEUSOS
00AF   2101           00346         call    ZEEread
00B0   00BA           00347         movwf   USOS
                      00348         
00B1   0008           00349         return
                      00350         
                      00351         
                      00352 ;display the configuration
00B2                  00353 showconfig
00B2   3008           00354         movlw   versionstr_h            ;version string
00B3   00DE           00355         movwf   tblptr_h
00B4   3000           00356         movlw   versionstr_l
00B5   00DD           00357         movwf   tblptr_l
00B6   2225           00358         call    LCDstr
                      00359         
00B7   3020           00360         movlw   ' '     ;mode
00B8   2268           00361         call    LCDchar         
00B9   0834           00362         movfw   mode
00BA   3E30           00363         addlw   h'30'
00BB   2268           00364         call    LCDchar
                      00365         
00BC   3020           00366         movlw   ' '     ;baud rate
00BD   2268           00367         call    LCDchar
00BE   0835           00368         movfw   baud_rate       
00BF   3C2D           00369         sublw   .45
00C0   1903 28D1      00370         bz      sc45                    
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 13


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

00C2   0835           00371         movfw   baud_rate
00C3   3C32           00372         sublw   .50
00C4   1903 28D6      00373         bz      sc50
00C6   0835           00374         movfw   baud_rate
00C7   3C4B           00375         sublw   .75
00C8   1903 28DB      00376         bz      sc75
00CA   3031           00377         movlw   '1'
00CB   2268           00378         call    LCDchar
00CC   3030           00379         movlw   '0'
00CD   2268           00380         call    LCDchar
00CE   3030           00381         movlw   '0'
00CF   2268           00382         call    LCDchar         
00D0   28E0           00383         goto    scfl
                      00384         
00D1   3034           00385 sc45    movlw   '4'
00D2   2268           00386         call    LCDchar
00D3   3035           00387         movlw   '5'
00D4   2268           00388         call    LCDchar
00D5   28E0           00389         goto    scfl
                      00390         
00D6   3035           00391 sc50    movlw   '5'
00D7   2268           00392         call    LCDchar
00D8   3030           00393         movlw   '0'
00D9   2268           00394         call    LCDchar
00DA   28E0           00395         goto    scfl
                      00396         
00DB   3037           00397 sc75    movlw   '7'
00DC   2268           00398         call    LCDchar
00DD   3035           00399         movlw   '5'
00DE   2268           00400         call    LCDchar
00DF   28E0           00401         goto    scfl
                      00402 
                      00403 
00E0   3020           00404 scfl    movlw   ' '     ;other configs
00E1   2268           00405         call    LCDchar 
00E2   0836           00406         movfw   TUreverse
00E3   3AFF           00407         xorlw   h'ff'   
00E4   1D03           00408         skpz
00E5   3020           00409         movlw   h'20'
00E6   3E52           00410         addlw   'R'     
00E7   2268           00411         call    LCDchar
                      00412         
00E8   0837           00413         movfw   PCcrlf
00E9   3AFF           00414         xorlw   h'ff'   
00EA   1D03           00415         skpz
00EB   3020           00416         movlw   h'20'
00EC   3E4C           00417         addlw   'L'     
00ED   2268           00418         call    LCDchar 
                      00419         
00EE   0838           00420         movfw   diddles
00EF   3AFF           00421         xorlw   h'ff'   
00F0   1D03           00422         skpz
00F1   3020           00423         movlw   h'20'
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 14


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

00F2   3E44           00424         addlw   'D'     
00F3   2268           00425         call    LCDchar 
                      00426 
                      00427         
00F4   0839           00428         movfw   autostart
00F5   3AFF           00429         xorlw   h'ff'   
00F6   1D03           00430         skpz
00F7   3020           00431         movlw   h'20'
00F8   3E53           00432         addlw   'S'     
00F9   2268           00433         call    LCDchar
                      00434         
00FA   083A           00435         movfw   USOS
00FB   3AFF           00436         xorlw   h'ff'   
00FC   1D03           00437         skpz
00FD   3020           00438         movlw   h'20'
00FE   3E55           00439         addlw   'U'     
00FF   2268           00440         call    LCDchar
0100   2898           00441         goto    menusigreset
                      00442 ;       return
                      00443 ;}
                      00444 
                      00445 
                      00446 ;EEPROM UTILITIES
                      00447 ;{
                      00448 
                      00449 
0101                  00450 ZEEread
                      00451         Bank2
0101   1283               M         bcf STATUS, RP0
0102   1703               M         bsf STATUS, RP1
0103   008D           00452         movwf   EEADR           ;Put desired address into EEADR
                      00453         Bank3
0104   1683               M         bsf STATUS, RP0
0105   1703               M         bsf STATUS, RP1
0106   138C           00454         bcf     EECON1,EEPGD
0107   140C           00455         bsf     EECON1,RD       ;RD operation flag
                      00456         Bank2
0108   1283               M         bcf STATUS, RP0
0109   1703               M         bsf STATUS, RP1
010A   080C           00457         movfw   EEDATA           ;Read data, put into W register
                      00458         Bank0
010B   1283               M         bcf STATUS, RP0
010C   1303               M         bcf STATUS, RP1
010D   0008           00459         return
                      00460         
                      00461 
                      00462 ; WriteEE: Writes a byte to the EEPROM of the PIC16F876
                      00463 ; Parameters: address in the EEPROM (0-63 dec) in the W register, data in the eewritedata
                      00464 ; Returns: nothing
                      00465 
010E                  00466 ZEEwrite
                      00467         Bank2
010E   1283               M         bcf STATUS, RP0
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 15


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

010F   1703               M         bsf STATUS, RP1
0110   008C           00468         movwf   EEDATA          ;Put data to be written into EEDATA
                      00469         Bank0
0111   1283               M         bcf STATUS, RP0
0112   1303               M         bcf STATUS, RP1
0113   0833           00470         movfw   eewriteaddress  ;Put desired address into EEADR
                      00471         Bank2
0114   1283               M         bcf STATUS, RP0
0115   1703               M         bsf STATUS, RP1
0116   008D           00472         movwf   EEADR
                      00473 
                      00474         Bank3
0117   1683               M         bsf STATUS, RP0
0118   1703               M         bsf STATUS, RP1
0119   138B           00475         BCF     INTCON, GIE     ; Disable INTs.
011A   120C           00476         bcf     EECON1,EEIF     ;clear busy flag
011B   138C           00477         bcf     EECON1,EEPGD
011C   150C           00478         bsf     EECON1,WREN     ;Write Enable flag
011D   3055           00479         movlw   h'55'           ;Required sequence to write to EEPROM
011E   008D           00480         movwf   EECON2
011F   30AA           00481         movlw   h'AA'
0120   008D           00482         movwf   EECON2
0121   148C           00483         bsf     EECON1,WR       ;set WR operation flag
0122   178B           00484         BSF     INTCON, GIE     ; Enable INTs.
0123   110C           00485         bcf     EECON1,WREN     ;Disable Write Enable flag
0124   188C           00486 EEIsBusy        btfsc   EECON1,WR       ;Wait for end of write 
0125   2924           00487         goto    EEIsBusy        
                      00488         Bank0
0126   1283               M         bcf STATUS, RP0
0127   1303               M         bcf STATUS, RP1
0128   0008           00489         return          
                      00490 ;}
                      00491 
                      00492 ;ITA2/ASCIII CONVERSION UTILITIES
                      00493 ;{
                      00494 
                      00495 ;convert ASCII  code to ITA2
                      00496 ; enter with acsii code in W which is used as the index to the table
                      00497 ; return with ITA2 character in ITA2char and W containing U, L, F, or B 
0129   2194           00498 Ccatoi  call    Ccgotoentry             ;table lookup call
012A   3001           00499         movlw   .1              ;move to the shift field
012B   21AD           00500         call    Ccaddoffset
012C   21B6           00501         call    Readflash
012D   085F           00502         movfw   tblval_l        
012E   00EB           00503         movwf   cctemp2 ; and store temporarily 
012F   3001           00504         movlw   .1      ;get the ITA2 character 
0130   21AD           00505         call    Ccaddoffset
0131   21B6           00506         call    Readflash
0132   085F           00507         movfw   tblval_l
0133   00F0           00508         movwf   ITA2char        ;and store it
0134   086B           00509         movfw   cctemp2   ; get the shift
0135   0008           00510         return
                      00511 
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 16


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00512 
                      00513 ;Convert ITA2 to ASCII
                      00514 ; enter with ITA2 character in W and receiver shift in cc_temp_shift
                      00515 ; return with ASCII character in W and receiver shift in cc_temp_shift
                      00516 ; only returns legal ITA2 characters; non printing are:
                      00517 ;CR LF and NUL are converted to their ASCII equivalents
                      00518 ; WRU is converted to #
                      00519 ; BEL is converted to ^
                      00520 ; if a shift has occured character returned is ESC (0x1b) and shift is set.
                      00521 ; cc_temp_shift has current shift state of F or L
                      00522 
                      00523 ;Search through conversion table to get character with correct shift and ITA2 value.
                      00524 ;  B (both) matches either shift
                      00525 ;  received LTRS and FIGS just alters shift
                      00526 
                      00527 ; temp 5 - rxd char
                      00528 ; temp2 - shift from table
                      00529 ; temp3 - ITA2 from table
                      00530 ; temp4 - ascii from table 
                      00531 
                      00532 
                      00533 
0136   00EE           00534 Ccitoa  movwf   cctemp5         ;save ITA2 char to be converted
0137   3025           00535         movlw   codeconvert_l
0138   00DD           00536         movwf   tblptr_l
0139   3009           00537         movlw   codeconvert_h
013A   00DE           00538         movwf   tblptr_h        
013B   21B6           00539 Ccitoa2 call    Readflash
013C   085F           00540         movfw   tblval_l
013D   00ED           00541         movwf   cctemp4         ;get ascii value from this entry
013E   3001           00542         movlw   .1
013F   21AD           00543         call    Ccaddoffset             
0140   21B6           00544         call    Readflash
0141   085F           00545         movfw   tblval_l
0142   00EB           00546         movwf   cctemp2         ;get shift of table from this entry
0143   3001           00547         movlw   .1
0144   21AD           00548         call    Ccaddoffset             
0145   21B6           00549         call    Readflash
0146   085F           00550         movfw   tblval_l
0147   00EC           00551         movwf   cctemp3         ;get ITA2
0148   086B           00552         movfw   cctemp2         ;is table entry shift an undefined ITA2 character
0149   3C55           00553         sublw   'U'
014A   1903 296C      00554         bz      Ccitoa1
014C   086C           00555         movfw   cctemp3         ;is it a space character (4) if so treat as B.
014D   3C04           00556         sublw   .4              ; Table has been set to L to force space to be transmitted
014E   1903 2958      00557         bz      Ccitoa4         ; as letter for USOS. 
0150   086B           00558         movfw   cctemp2         ;is shift of table both
0151   3C42           00559         sublw   'B'             
0152   1903 2958      00560         bz      Ccitoa4         ;yes so can compare character
0154   086B           00561         movfw   cctemp2         ;is shift of entry same as current creed shift
0155   026F           00562         subwf   cc_temp_shift,w
0156   1D03 296C      00563         bnz     Ccitoa1         ;no so try the next character
0158   086C           00564 Ccitoa4 movfw   cctemp3         ; shifts match what about the ITA2 value
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 17


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0159   026E           00565         subwf   cctemp5,w                       
015A   1D03 296C      00566         bnz     Ccitoa1         ;ITA2 codes don't match try next entry
                      00567         
                      00568 ;Found the right entry
015C   086E           00569         movfw   cctemp5
015D   3C1F           00570         sublw   .31             ;is received character a letters shift
015E   1903 2966      00571         bz      Ccitoa5         ;yes
0160   086E           00572         movfw   cctemp5
0161   3C1B           00573         sublw   .27             ;or figures shift
0162   1903 2969      00574         bz      Ccitoa6         ;yes
0164   086D           00575         movfw   cctemp4         ;just a ordinary character so return received character
0165   0008           00576         return
                      00577         
0166   304C           00578 Ccitoa5 movlw   'L'             ;set shift and return
0167   00EF           00579         movwf   cc_temp_shift
0168   341B           00580         retlw   0x1b
                      00581         
0169   3046           00582 Ccitoa6 movlw   'F'             ;set shift and return
016A   00EF           00583         movwf   cc_temp_shift
016B   341B           00584         retlw   0x1b
                      00585                 
016C   3001           00586 Ccitoa1 movlw   .1              ; goto next entry in table
016D   21AD           00587         call    Ccaddoffset
016E   293B           00588         goto    Ccitoa2
                      00589                                 
                      00590 
                      00591  
                      00592 ;***************************************************************************
                      00593 ;**  time efficient multiplication 8 bit x 8 bit = 16 bit (unsigned)
                      00594 ;**  http://www.piclist.com/techref/microchip/math/mul/8x8.htm
                      00595 ;**  multiplier:            w
                      00596 ;**  multiplicand:    resultlo
                      00597 ;**  result:        resulthi:resultlo
                      00598 ;***************************************************************************
                      00599 
016F                  00600 Mul8x8
                      00601 
                      00602 mult    MACRO
                      00603         btfsc   STATUS,C
                      00604         addwf   resulthi,F
                      00605         rrf     resulthi,F
                      00606         rrf     resultlo,F
                      00607         ENDM
                      00608 
                      00609         Bank2
016F   1283               M         bcf STATUS, RP0
0170   1703               M         bsf STATUS, RP1
0171   01A3           00610         clrf    resulthi
0172   0CA4           00611                 rrf     resultlo,F
                      00612         mult
0173   1803               M         btfsc   STATUS,C
0174   07A3               M         addwf   resulthi,F
0175   0CA3               M         rrf     resulthi,F
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 18


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0176   0CA4               M         rrf     resultlo,F
                      00613         mult
0177   1803               M         btfsc   STATUS,C
0178   07A3               M         addwf   resulthi,F
0179   0CA3               M         rrf     resulthi,F
017A   0CA4               M         rrf     resultlo,F
                      00614         mult
017B   1803               M         btfsc   STATUS,C
017C   07A3               M         addwf   resulthi,F
017D   0CA3               M         rrf     resulthi,F
017E   0CA4               M         rrf     resultlo,F
                      00615         mult
017F   1803               M         btfsc   STATUS,C
0180   07A3               M         addwf   resulthi,F
0181   0CA3               M         rrf     resulthi,F
0182   0CA4               M         rrf     resultlo,F
                      00616         mult
0183   1803               M         btfsc   STATUS,C
0184   07A3               M         addwf   resulthi,F
0185   0CA3               M         rrf     resulthi,F
0186   0CA4               M         rrf     resultlo,F
                      00617         mult
0187   1803               M         btfsc   STATUS,C
0188   07A3               M         addwf   resulthi,F
0189   0CA3               M         rrf     resulthi,F
018A   0CA4               M         rrf     resultlo,F
                      00618         mult
018B   1803               M         btfsc   STATUS,C
018C   07A3               M         addwf   resulthi,F
018D   0CA3               M         rrf     resulthi,F
018E   0CA4               M         rrf     resultlo,F
                      00619         mult
018F   1803               M         btfsc   STATUS,C
0190   07A3               M         addwf   resulthi,F
0191   0CA3               M         rrf     resulthi,F
0192   0CA4               M         rrf     resultlo,F
0193   3400           00620         retlw 0
                      00621  
                      00622  
                      00623 ; On entry the index of the table entry is in W
                      00624 ; On exit the address of byte 0 of the accessed entry is in tblptr so it can be used by Inctblptr or cca
                            ddoffset
                      00625 ; however tblptr is also used by other tasks so is only guaranteed to be valid in one one instantiation 
                            of a task.
                      00626 
                      00627 Ccgotoentry     Bank2
0194   1283               M         bcf STATUS, RP0
0195   1703               M         bsf STATUS, RP1
0196   00A4           00628         movwf   resultlo        ;store the index ready for mult
0197   3003           00629         movlw   .3
0198   216F           00630         call    Mul8x8  ;result in resulthi and resultlo
                      00631         Bank0
0199   1283               M         bcf STATUS, RP0
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 19


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

019A   1303               M         bcf STATUS, RP1
019B   3025           00632         movlw   codeconvert_l
                      00633         Bank2
019C   1283               M         bcf STATUS, RP0
019D   1703               M         bsf STATUS, RP1
019E   0724           00634         addwf   resultlo,w
                      00635         Bank0
019F   1283               M         bcf STATUS, RP0
01A0   1303               M         bcf STATUS, RP1
01A1   00DD           00636         MOVWF   tblptr_l
01A2   3009           00637         MOVlw   codeconvert_h
01A3   1803           00638         BTFSC   STATUS, C
01A4   3E01           00639         ADDLW   .1      ; if a carry on adding low bytes occurred, add 1
01A5   0000           00640         nop
                      00641         Bank2
01A6   1283               M         bcf STATUS, RP0
01A7   1703               M         bsf STATUS, RP1
01A8   0723           00642         addwf   resulthi,w      ; add high byte of multiplied index
                      00643         Bank0
01A9   1283               M         bcf STATUS, RP0
01AA   1303               M         bcf STATUS, RP1
01AB   00DE           00644         MOVWF   tblptr_h
01AC   0008           00645         return
                      00646 
                      00647 ; offset is in W on entry
                      00648 ; increments tblptr by offset
                      00649 ; can be used to access the fields of a table entry or to move to the next field if W=3 
01AD                  00650 Ccaddoffset
01AD   00EA           00651         movwf   cctemp1
01AE   085D           00652         MOVFw   tblptr_l
01AF   076A           00653         addwf   cctemp1,w
01B0   00DD           00654         MOVWF   tblptr_l
01B1   085E           00655         MOVfw   tblptr_h
01B2   1803           00656         BTFSC   STATUS, C
01B3   3E01           00657         ADDLW   .1              ; if a carry occurred, add 1
01B4   00DE           00658         MOVWF   tblptr_h
01B5   0008           00659         return
                      00660 ;}              
                      00661 
                      00662 
                      00663 ;TABLE ACCESS UTILITIES
                      00664 ;{
                      00665 ; ***********************************************
                      00666 ; READ FLASH MEMORY:
                      00667 ; AN39582B.PDF
                      00668 ; ***********************************************
                      00669 ; reads data word in program memory pointed to by tblptr_h and tblptr_l
                      00670 ; result is stored in tblval_h and tblval_l
                      00671  
01B6                  00672 Readflash
                      00673         Bank0
01B6   1283               M         bcf STATUS, RP0
01B7   1303               M         bcf STATUS, RP1
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 20


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

01B8   085E           00674         MOVFw   tblptr_h                ;       
                      00675         Bank2   
01B9   1283               M         bcf STATUS, RP0
01BA   1703               M         bsf STATUS, RP1
01BB   008F           00676         MOVWF   EEADRH          ; MS Byte of Program Address to read
                      00677         Bank0
01BC   1283               M         bcf STATUS, RP0
01BD   1303               M         bcf STATUS, RP1
01BE   085D           00678         MOVFw   tblptr_l
                      00679         Bank2
01BF   1283               M         bcf STATUS, RP0
01C0   1703               M         bsf STATUS, RP1
01C1   008D           00680         MOVWF   EEADR           ; LS Byte of Program Address to read
                      00681         Bank3
01C2   1683               M         bsf STATUS, RP0
01C3   1703               M         bsf STATUS, RP1
01C4   178C           00682         BSF     EECON1, EEPGD   ; Point to PROGRAM memory
01C5   140C           00683         BSF     EECON1, RD      ; EE Read
01C6   0000           00684         NOP                     ; Any instructions here are ignored as program
01C7   0000           00685         NOP                     ; memory is read in second cycle after BSF EECON1,RD
                      00686         Bank2
01C8   1283               M         bcf STATUS, RP0
01C9   1703               M         bsf STATUS, RP1
01CA   080C           00687         MOVFw   EEDATA          ; W = LS Byte of Program EEDATA
                      00688         Bank0
01CB   1283               M         bcf STATUS, RP0
01CC   1303               M         bcf STATUS, RP1
01CD   00DF           00689         MOVWF   tblval_l
                      00690         Bank2
01CE   1283               M         bcf STATUS, RP0
01CF   1703               M         bsf STATUS, RP1
01D0   080E           00691         MOVFw   EEDATH          ; W = MS Byte of Program EEDATA
                      00692         Bank0
01D1   1283               M         bcf STATUS, RP0
01D2   1303               M         bcf STATUS, RP1
01D3   00E0           00693         MOVWF   tblval_h        
01D4   0008           00694         RETURN
                      00695 
                      00696 
01D5                  00697 Inctblptr
01D5   085D           00698         MOVFw   tblptr_l
01D6   3E01           00699         ADDLW   .1
01D7   00DD           00700         MOVWF   tblptr_l
01D8   085E           00701         MOVFw   tblptr_h
01D9   1803           00702         BTFSC   STATUS, C
01DA   3E01           00703         ADDLW   .1              ; if a carry occurred, add 1
01DB   00DE           00704         MOVWF   tblptr_h
01DC   0008           00705         RETURN
                      00706 
                      00707 
                      00708 
                      00709 
                      00710 
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 21


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00711 
                      00712 ;}
                      00713 ;LCD
                      00714 ;{
                      00715         
                      00716 ;;;; Busy delays which run at base level
                      00717                 
                      00718 ;******** DELAY LOOP x mS ********
                      00719 ;Delay 1mS x contents of W
                      00720 
                      00721 delaywms        Bank2
01DD   1283               M         bcf STATUS, RP0
01DE   1703               M         bsf STATUS, RP1
01DF   00A0           00722         movwf   LCDcount3               
01E0   21E8           00723 delaywms1       call    delay1ms
                      00724         Bank2
01E1   1283               M         bcf STATUS, RP0
01E2   1703               M         bsf STATUS, RP1
01E3   0BA0           00725         decfsz  LCDcount3,1
01E4   29E0           00726         goto    delaywms1
                      00727         Bank0
01E5   1283               M         bcf STATUS, RP0
01E6   1303               M         bcf STATUS, RP1
01E7   0008           00728         return
                      00729 ;*****************************  
                      00730 
                      00731 
                      00732 ;*********** DELAY LOOP approx 1mS ***********************
                      00733 delay1ms        Bank2
01E8   1283               M         bcf STATUS, RP0
01E9   1703               M         bsf STATUS, RP1
01EA   300A           00734         movlw   D'10'
01EB   00A1           00735         movwf   LCDcount2
01EC   21F4           00736 delay1ms1       call    delay100us
                      00737         Bank2
01ED   1283               M         bcf STATUS, RP0
01EE   1703               M         bsf STATUS, RP1
01EF   0BA1           00738         decfsz  LCDcount2,1
01F0   29EC           00739         goto    delay1ms1
                      00740         Bank0
01F1   1283               M         bcf STATUS, RP0
01F2   1303               M         bcf STATUS, RP1
01F3   0008           00741         return           
                      00742 ;**************************************************
                      00743         
                      00744 
                      00745 ;******** DELAY LOOP approx 100 MICRO SEC. *************
                      00746 delay100us      Bank2
01F4   1283               M         bcf STATUS, RP0
01F5   1703               M         bsf STATUS, RP1
01F6   3032           00747         movlw   D'50'   ; 50 cycles
01F7   00A2           00748                 movwf   LCDcount1       ; including call/return
01F8                  00749 delay100us1
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 22


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

01F8   0BA2           00750         decfsz  LCDcount1,1     ; 2 uS per loop
01F9   29F8           00751                 goto    delay100us1
                      00752                 Bank0
01FA   1283               M         bcf STATUS, RP0
01FB   1303               M         bcf STATUS, RP1
01FC   0008           00753                 return
                      00754 ;*************************************************
                      00755 
                      00756 ;LCD delays
                      00757 ; 100 uS between fast commands or data
                      00758 ; 2mS after slow commands
                      00759 ; 5 mS after initial byte
                      00760 ; 40 mS before start    
                      00761 
                      00762         
                      00763 ;*********** INITIALISE LCD MODULE 4 BIT MODE *******************
                      00764 
                      00765 
01FD                  00766 ZLCDinit        
01FD   1287           00767         bcf     LCD_RS  ;register select low
01FE   1207           00768         bcf     LCD_E   ;enable line low
                      00769         
01FF   3028           00770         movlw   D'40'
0200   21DD           00771         call    delaywms        ;wait 40 mS for lcd module hardware reset
                      00772         
                      00773 ; initially sending nibble in bits 3-0 to initialise the LCD 
0201   3003           00774         movlw   b'11'
0202   0087           00775         movwf   PORTC   
0203   1607           00776         bsf     LCD_E   ;ena high
0204   0000           00777         nop
0205   0000           00778         nop                             ;wait more than 470 ns
0206   1207           00779         bcf     LCD_E   ;ena low
0207   3005           00780         movlw   D'5'
0208   21DD           00781         call    delaywms       ;wait 5 mS for display to catch up
                      00782 
                      00783 
                      00784 ; initially sending nibble in bits 3-0 to initialise the LCD 
0209   3003           00785         movlw   b'11'
020A   0087           00786         movwf   PORTC   
020B   1607           00787         bsf     LCD_E   ;ena high
020C   0000           00788         nop
020D   0000           00789         nop                             ;wait more than 470 ns
020E   1207           00790         bcf     LCD_E   ;ena low
020F   21F4           00791         call    delay100us
                      00792 
                      00793 
                      00794 ; initially sending nibble in bits 3-0 to initialise the LCD 
0210   3003           00795         movlw   b'11'
0211   0087           00796         movwf   PORTC   
0212   1607           00797         bsf     LCD_E   ;ena high
0213   0000           00798         nop
0214   0000           00799         nop                             ;wait more than 470 ns
0215   1207           00800         bcf     LCD_E   ;ena low
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 23


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0216   21F4           00801         call    delay100us
                      00802 
                      00803 
                      00804 ; initially sending nibble in bits 3-0 to initialise the LCD 
0217   3002           00805         movlw   b'10'
0218   0087           00806         movwf   PORTC   
0219   1607           00807         bsf     LCD_E   ;ena high
021A   0000           00808         nop
021B   0000           00809         nop                             ;wait more than 470 ns
021C   1207           00810         bcf     LCD_E   ;ena low
021D   21F4           00811         call    delay100us
                      00812 
                      00813 
                      00814 ; now sending a byte
                      00815 ; set to 4 bit mode and send NF
                      00816                         ; N: 1= 2 lines, 0= 1 line
                      00817                         ; F: 1= 5x11 font, 0= 5x8 font
                      00818 
021E   3028           00819         movlw   b'00101000'   ; 0010 NFxx
021F   2254           00820         call    LCDcom
                      00821         
0220   2234           00822         call    LCDoff
0221   224A           00823         call    LCDclear
                      00824 ;       call    LCDhome 
0222   223B           00825         call    LCDscroll
                      00826 
0223   2231           00827         call    LCDon
0224   0008           00828         return
                      00829 
                      00830 
                      00831 ; LCDstr
                      00832 
                      00833 ; writes a string to the LCD
                      00834 ; string is pointed to be tblptr_h and tblptr_l
                      00835 ; string is stored one character per word in the lsbits.
                      00836 ; string is terminated by a null character (0)
                      00837 ; string is between 0 and 16 characters so display will not overflow.
                      00838         
0225   224A           00839 LCDstr  call    LCDclear
0226                  00840 LCDstrappend
0226   21B6           00841         call    Readflash       ;get  a character
0227   085F           00842         movfw   tblval_l
0228   1903 2A2D      00843         bz      LCDstr1 ; if 0 then end of string
022A   2268           00844         call    LCDchar ; print it
022B   21D5           00845         call    Inctblptr
022C   2A26           00846         goto    LCDstrappend
022D   0008           00847 LCDstr1 return
                      00848 
                      00849         
                      00850 ;**********************************************************
                      00851 
                      00852 ;set LCD RAM address to content of W
022E                  00853 LCDaddress
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 24


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

022E   3880           00854         iorlw   b'10000000'
022F   2254           00855         call    LCDcom          
0230   0008           00856         return
                      00857         
                      00858 ; TURN DISPLAY ON
                      00859                         ; D: Display on(1)/0ff(0)
                      00860                         ; C: Cursor on(1)/0ff(0)
                      00861                         ; B: Blink on(1)/0ff(0)
0231                  00862 LCDon
                      00863                 
0231   300C           00864         movlw   b'00001100'   ;  0000 1DCB
0232   2254           00865         call    LCDcom
0233   0008           00866         return
                      00867 
                      00868 
                      00869 ; DISPLAY OFF
                      00870                         ; D: Display on(1)/0ff(0)
                      00871                         ; C: Cursor on(1)/0ff(0)
                      00872                         ; B: Blink on(1)/0ff(0)
0234                  00873 LCDoff
                      00874                 
0234   3008           00875         movlw   b'00001000'   ;  0000 1DCB
0235   2254           00876         call    LCDcom
0236   0008           00877         return
                      00878 
                      00879 ; SET DISPLAY TO STATIC DISPLAY MODE
                      00880                         ; I: 1= Increment counter, 0= Decrement counter
                      00881                         ; S: 1= "Display shift"
0237                  00882 LCDstatic       
0237   3006           00883         movlw   b'00000110'     ;0000 01IS
0238   2254           00884         call    LCDcom
0239   224A           00885         call    LCDclear
023A   0008           00886         return
                      00887 
                      00888 ;SET DISPLAY TO SCROLL DISPLAY MODE
                      00889 
023B                  00890 LCDscroll       
023B   3007           00891         movlw   b'00000111'     ;0000 01IS
023C   2254           00892         call    LCDcom
023D   224A           00893         call    LCDclear        ;clear the display
023E   3010           00894         movlw   d'16'   ; set RAM address to right end of display area
023F   00DB           00895         movwf   LCDpos
0240   222E           00896         call    LCDaddress
0241   0008           00897         return
                      00898 
                      00899 ; keep track of location in character buffer and reset to 0 when it gets to 39  
0242                  00900 LCDshift
0242   0ADB           00901         incf    LCDpos,f
0243   3028           00902         movlw   d'40'
0244   025B           00903         subwf   LCDpos,w                                                
0245   1D03 2A49      00904         bnz     LCDshift1
0247   00DB           00905         movwf   LCDpos  ;end of buffer so reset to 0
0248   222E           00906         call    LCDaddress
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 25


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0249   0008           00907 LCDshift1       return
                      00908         
                      00909         
                      00910 ; CLEAR DISPLAY
                      00911 
024A   3001           00912 LCDclear        movlw   0x01            ;Command to clear display
024B   2254           00913         call    LCDcom
024C   3002           00914         movlw   D'2'
024D   21DD           00915         call    delaywms
024E   0008           00916         return
                      00917         
                      00918 
                      00919 ; MOVE TO HOME 
024F   3002           00920 LCDhome movlw   0x02            ;Command to 'home' display.
0250   2254           00921         call    LCDcom
0251   3002           00922         movlw   D'2'
0252   21DD           00923         call    delaywms
0253   0008           00924         return
                      00925 
                      00926 
                      00927         
                      00928 
                      00929 ;******* LCDcom  ******************
                      00930 ; Sends command to LCD display (4 BIT MODE)   
                      00931 
0254   0187           00932 LCDcom  clrf    PORTC
0255   1287           00933         bcf     LCD_RS  ;Set RS to send command to LCD module
0256   00DC           00934         movwf   LCDbyte ;store byte
                      00935 
0257   0E5C           00936         swapf   LCDbyte,0       ;swap upper and lower nibbles (4 bit mode)
0258   390F           00937         andlw   0x0f    ;mask off lower 4 bits
0259   0487           00938         iorwf   PORTC,f ;send to display        
025A   1607           00939         bsf     LCD_E   ;ena high       
025B   0000           00940         nop                     
025C   1207           00941         bcf     LCD_E   ;ena low 
                      00942 
025D   21F4           00943         call    delay100us
                      00944 
025E   0187           00945         clrf    PORTC
025F   1287           00946         bcf     LCD_RS  ;Set RS to send command to LCD module
0260   085C           00947         movfw   LCDbyte ;get byte again 
0261   390F           00948         andlw   0x0f    ;mask off lower 4 bits
0262   0487           00949         iorwf   PORTC,f ;send data to display   
0263   1607           00950         bsf     LCD_E   ;ena high
0264   0000           00951         nop                     
0265   1207           00952         bcf     LCD_E   ;ena low
                      00953 
0266   21F4           00954         call    delay100us
0267   0008           00955         return  
                      00956 
                      00957 
                      00958 ;******* LCDchar  ******************
                      00959 ; Sends character to LCD display (4 BIT MODE)   
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 26


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00960 
0268   0187           00961 LCDchar clrf    PORTC
0269   1687           00962         bsf     LCD_RS  ;Set RS to send character to LCD module
026A   00DC           00963         movwf   LCDbyte ;store byte to be displayed
026B   3021           00964         movlw   H'21'   ; is character non-printing?
026C   025C           00965         subwf   LCDbyte,w
026D   1803 2A71      00966         bc      LCDchar1
026F   3020           00967         movlw   h'20'   ; print a space
0270   00DC           00968         movwf   LCDbyte
0271   0E5C           00969 LCDchar1        swapf   LCDbyte,0       ;swap upper and lower nibbles (4 bit mode)
0272   390F           00970         andlw   0x0f    ;mask off lower 4 bits
0273   0487           00971         iorwf   PORTC,f ;send data to display   
0274   1607           00972         bsf     LCD_E   ;ena high       
0275   0000           00973         nop                     
0276   1207           00974         bcf     LCD_E   ;ena low 
                      00975 
0277   21F4           00976         call    delay100us
                      00977 
0278   0187           00978         clrf    PORTC
0279   1687           00979         bsf     LCD_RS  ;Set RS to send character to LCD module
027A   085C           00980         movfw   LCDbyte ;get char again 
027B   390F           00981         andlw   0x0f    ;mask off lower 4 bits
027C   0487           00982         iorwf   PORTC,f ;send data to display   
027D   1607           00983         bsf     LCD_E   ;ena high
027E   0000           00984         nop                     
027F   1207           00985         bcf     LCD_E   ;ena low
                      00986 
0280   21F4           00987         call    delay100us  
0281   0008           00988         return  
                      00989 ;*****************************
                      00990 
                      00991 ;}
                      00992 
                      00993 ;USART
                      00994 ;{
                      00995         
0282                  00996 ZUSARTinit
                      00997 
                      00998                         ;SPBRG for BRGH=0
                      00999                         ; 300 baud - 207
                      01000                         ; 2400 baud - 25
                      01001         Bank1
0282   1683               M         bsf STATUS, RP0
0283   1303               M         bcf STATUS, RP1
0284   0198           01002         clrf    TXSTA   ;set to known state
                      01003         Bank0
0285   1283               M         bcf STATUS, RP0
0286   1303               M         bcf STATUS, RP1
0287   0198           01004         clrf    RCSTA
                      01005         Bank1   
0288   1683               M         bsf STATUS, RP0
0289   1303               M         bcf STATUS, RP1
                      01006                         ;set baud rate
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 27


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

028A   1118           01007         bcf     TXSTA,BRGH      ;low speed              
028B   30CF           01008         MOVLW   .207            ; and  300 baud
028C   0099           01009         MOVWF   SPBRG
                      01010         
                      01011         Bank0
028D   1283               M         bcf STATUS, RP0
028E   1303               M         bcf STATUS, RP1
028F   1798           01012         bsf     RCSTA,SPEN      ;enable serial port?    
                      01013         
                      01014         Bank1
0290   1683               M         bsf STATUS, RP0
0291   1303               M         bcf STATUS, RP1
0292   1698           01015         bsf     TXSTA,TXEN      ;and enable Tx
                      01016         
                      01017         Bank0
0293   1283               M         bcf STATUS, RP0
0294   1303               M         bcf STATUS, RP1
0295   1618           01018         bsf     RCSTA,CREN      ;receiver enabled
                      01019 
                      01020                 
                      01021                         ;TXSTA  bit1 - TRMT - shift reg empty
                      01022         
                      01023                         ;RCSTA  bit 2 - framing error
                      01024                         ;       bit 1 - overun error
                      01025 
0296   01A2           01026         clrf    usart_rx_data_full              ; clear signals
0297   01A4           01027         clrf    usart_tx_data_full
0298   30B0           01028         movlw   usart_tx_buffer
0299   00A5           01029         movwf   usart_write_pointer
029A   00A6           01030         movwf   usart_read_pointer
                      01031         
029B   0008           01032         return
                      01033         
                      01034         
                      01035         
                      01036 ; USART Tx output is buffered twice
                      01037 ; First there is a 16 character buffer written to by USARTchar. This is needed because some output
                      01038 ; operations output two characters in quick succession mainly when sending LF after CR
                      01039 ; Secondly there is a single character usart_tx_data which is the interface between the base level and i
                            nterrupt level.
                      01040 ; The reason for this is to remove the need to manipulate pointers in the interrupt routine. It also giv
                            es an alternative way
                      01041 ; for base level tasks to send characters (but don't use both in the same program) 
                      01042 
                      01043 ; USARTchar writes a character to the 16 character  USART Tx buffer
                      01044 ; character is in W on entry and exit.
                      01045 
                      01046         
029C                  01047 USARTchar
029C   00A7           01048         movwf   usartchar1              ; save character
029D   0A25           01049         incf    usart_write_pointer,W   ; is buffer full - W = WPTR + 1
029E   390F           01050         andlw   h'0F'           ; keep it in range 00..0F
029F   3EB0           01051         addlw   usart_tx_buffer ; add buffer start address
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 28


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

02A0   00A8           01052         movwf   usartchar2              ; save pointer here temporarily for storing it
02A1   0626           01053         xorwf   usart_read_pointer,W    ; buffer full (WPTR+1=RPTR)   
02A2   1903 2AAC      01054         bz      USARTcharerror  ; buffer full so error
02A4   0825           01055         movfw   usart_write_pointer             ; get TX buffer Wr ptr
02A5   0084           01056         movwf   FSR             ; setup indirect address
02A6   0827           01057         movfw   usartchar1              ; get character
02A7   0080           01058         movwf   INDF            ; place it in TX buffer
02A8   0828           01059                 movfw   usartchar2              ; get saved cpb_write_pointer+1 value
02A9   00A5           01060         movwf   usart_write_pointer             ; update cpb_write_pointer
02AA   0827           01061         movfw   usartchar1              ; and place the character back in W     
02AB   0008           01062         return
                      01063         
02AC                  01064 USARTcharerror
02AC   300A           01065         movlw   errutbuf_h
02AD   00DE           01066         movwf   tblptr_h
02AE   30CF           01067         movlw   errutbuf_l
02AF   00DD           01068         movwf   tblptr_l
02B0   3005           01069         movlw   menu_err
02B1   00AF           01070         movwf   menu_state
02B2   2237           01071         call    LCDstatic
02B3   224F           01072         call    LCDhome
02B4   2225           01073         call    LCDstr
02B5                  01074 USARTcharerror1
02B5   2AB5           01075         goto    USARTcharerror1
                      01076 
                      01077 
                      01078 ; emptying the long print buffer into the character buffer. 
02B6                  01079 USARTbuftotx
02B6   0826           01080         movfw   usart_read_pointer              ;Anything to print?
02B7   0625           01081         xorwf   usart_write_pointer,W       
02B8   1903 2AC7      01082         bz      USARTbuftotxend ; no so exit
02BA   0824           01083         movfw   usart_tx_data_full       ;is USART busy printing
02BB   1D03 2AC7      01084         bnz     USARTbuftotxend ; yes so exit
02BD   0826           01085         movfw   usart_read_pointer      ; get TX buffer Rd ptr
02BE   0084           01086         movwf   FSR             ; setup indirect address
02BF   0800           01087         movfw   INDF            ; get data
02C0   00A3           01088         movwf   usart_tx_data
02C1   30FF           01089         movlw   true
02C2   00A4           01090         movwf   usart_tx_data_full
02C3   0A26           01091         incf    usart_read_pointer,W    ; W = cpb_read_pointer + 1 
02C4   390F           01092         andlw   h'0F'           ; keep in range 00..0F 
02C5   3EB0           01093         addlw   usart_tx_buffer ; add base address of buffer
02C6   00A6           01094                 movwf   usart_read_pointer      ; update read pointer  
                      01095                 
02C7                  01096 USARTbuftotxend 
02C7   0008           01097         return
                      01098 
                      01099 
                      01100 
                      01101 ; RCIF bit in PIR set if RX bufffer is full
                      01102 ; data in RCREG
                      01103 ; check OERR and FERR 
                      01104 
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 29


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

02C8   1E8C           01105 USARTrx btfss   PIR1,RCIF               ; status bit set if buffer full
02C9   2AD2           01106         goto    USARTrxend      ;buffer empty
02CA   0818           01107         movfw   RCSTA           ;test for frame or overun errors
02CB   3906           01108         andlw   b'110'
02CC   1D03 2AD3      01109         bnz     USARTrxerr
02CE   081A           01110         movfw   RCREG
02CF   00A1           01111         movwf   usart_rx_data   ;save data and set signal
02D0   30FF           01112         movlw   true
02D1   00A2           01113         movwf   usart_rx_data_full
                      01114 
                      01115 
02D2                  01116 USARTrxend
02D2   0008           01117         return
                      01118         
02D3                  01119 USARTrxerr
02D3   300A           01120         movlw   errurbuf_h
02D4   00DE           01121         movwf   tblptr_h
02D5   30C5           01122         movlw   errurbuf_l
02D6   00DD           01123         movwf   tblptr_l
02D7   3005           01124         movlw   menu_err
02D8   00AF           01125         movwf   menu_state
02D9   2237           01126         call    LCDstatic
02DA   224F           01127         call    LCDhome
02DB   2225           01128         call    LCDstr
02DC                  01129 USARTrx1
02DC   2ADC           01130         goto    USARTrx1
                      01131 
                      01132 
                      01133 ;Transmit
                      01134 ; TXIF bit in PIR is set if TX buffer empty     
                      01135 ; put data byte to be transmitted in TXREG
                      01136 
02DD   1E0C           01137 USARTtx btfss   PIR1,TXIF               ;bit set if hardware buffer empty
02DE   2AE6           01138         goto    USARTtxend      ;buffer not yet empty
02DF   0824           01139         movfw   usart_tx_data_full      ;is there data available to print
02E0   1903 2AE6      01140         bz      USARTtxend      ;no
02E2   0823           01141         movfw   usart_tx_data
02E3   0099           01142         movwf   TXREG
02E4   3000           01143         movlw   false
02E5   00A4           01144         movwf   usart_tx_data_full
                      01145         
02E6                  01146 USARTtxend
02E6   0008           01147         return
                      01148 ;}
                      01149 
                      01150 ;CREED
                      01151 ;{
                      01152 
                      01153 ;  initialize Creed I/O
                      01154 ;
02E7   01D0           01155 ZCreedinit      clrf    CRRX_SM         ; clr RX state machine 
02E8   01CF           01156         clrf    CRTX_SM         ; clr TX state machine 
02E9   3000           01157         movlw   false           ; character buffer empty
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 30


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

02EA   00D2           01158         movwf   creed_printer_data_full
02EB   30A0           01159         movlw   creed_printer_buffer
02EC   00D3           01160         movwf   cpb_write_pointer               ;16 character buffer empty
02ED   00D4           01161         movwf   cpb_read_pointer
02EE   304C           01162         movlw   'L'             ;print letters shift to initilise the Creed
02EF   00DA           01163         movwf   creed_printer_shift
02F0   00D9           01164         movwf   creed_kb_shift
                      01165         
                      01166         DoMark                           ; send mark (idle to printer)  
02F1   1106               M         bcf     PORTB,creed_printer_data_bit
                      01167 
02F2   301F           01168         movlw   .31
02F3   22F8           01169         call    Creedchar
02F4   22F8           01170         call    Creedchar
                      01171         
02F5   3000           01172         movlw   false
02F6   00D8           01173         movwf   creed_kb_data_full
                      01174 ;
                      01175 
02F7   0008           01176         return
                      01177 
                      01178 
                      01179 ; Creed printer output is buffered twice
                      01180 ; First there is a 16 character buffer written to by Creedchar. This is needed because some creed printi
                            ng
                      01181 ; operations output two characters in quick succession mainly when sending shift characters before a pri
                            nting character.
                      01182 ; Secondly there is a single cahracter creed_printer_data which is the interface between the base level 
                            and interrupt level.
                      01183 ; The reason for this is to remove the need to manipulate pointers in the interrupt routine. It also giv
                            es an alternative way
                      01184 ; for base level tasks to send characters (but don't use both in the same program) 
                      01185 
                      01186 ; Creedchar writes a character to the 16 character Creed Printer buffer
                      01187 ; character is in W on entry and exit.
                      01188 
                      01189         
02F8                  01190 Creedchar
02F8   00D5           01191         movwf   creedchar1              ; save character
02F9   0A53           01192         incf    cpb_write_pointer,W     ; is buffer full - W = WPTR + 1
02FA   390F           01193         andlw   h'0F'           ; keep it in range 00..0F
02FB   3EA0           01194         addlw   creed_printer_buffer    ; add buffer start address
02FC   00D6           01195         movwf   creedchar2              ; save pointer here temporarily for storing it
02FD   0654           01196         xorwf   cpb_read_pointer,W      ; buffer full (WPTR+1=RPTR)   
02FE   1903 2B08      01197         bz      Creedcharerror  ; buffer full so error
0300   0853           01198         movfw   cpb_write_pointer               ; get TX buffer Wr ptr
0301   0084           01199         movwf   FSR             ; setup indirect address
0302   0855           01200         movfw   creedchar1              ; get character
0303   0080           01201         movwf   INDF            ; place it in TX buffer
0304   0856           01202                 movfw   creedchar2              ; get saved cpb_write_pointer+1 value
0305   00D3           01203         movwf   cpb_write_pointer               ; update cpb_write_pointer
0306   0855           01204         movfw   creedchar1              ; and place the character back in W     
0307   0008           01205         return
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 31


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      01206         
0308                  01207 Creedcharerror
0308   138B           01208         bcf     INTCON, GIE             ; Disable interrupts
0309   300A           01209         movlw   errcpbuf_h
030A   00DE           01210         movwf   tblptr_h
030B   30A5           01211         movlw   errcpbuf_l
030C   00DD           01212         movwf   tblptr_l
030D   3005           01213         movlw   menu_err
030E   00AF           01214         movwf   menu_state
030F   2237           01215         call    LCDstatic
0310   224F           01216         call    LCDhome
0311   2225           01217         call    LCDstr  
0312                  01218 Creedcharerror1
0312   2B12           01219         goto    Creedcharerror1
                      01220         
                      01221 ; emptying the long print buffer into the character buffer. 
0313                  01222 Creedbuftotx
0313   0854           01223         movfw   cpb_read_pointer        ;Anything to print?
0314   0653           01224         xorwf   cpb_write_pointer,W       
0315   1903 2B25      01225         bz      Creedbuftotxend ; no so exit
0317   138B           01226         bcf     INTCON, GIE             ; Disable interrupts
0318   0852           01227         movfw   creed_printer_data_full  ;is creed busy printing
0319   1D03 2B25      01228         bnz     Creedbuftotxend ; yes so exit
031B   0854           01229         movfw   cpb_read_pointer                ; get TX buffer Rd ptr
031C   0084           01230         movwf   FSR             ; setup indirect address
031D   0800           01231         movfw   INDF            ; get data
031E   00D1           01232         movwf   creed_printer_data
031F   30FF           01233         movlw   true
0320   00D2           01234         movwf   creed_printer_data_full
0321   0A54           01235         incf    cpb_read_pointer,W      ; W = cpb_read_pointer + 1 
0322   390F           01236         andlw   h'0F'           ; keep in range 00..0F 
0323   3EA0           01237         addlw   creed_printer_buffer    ; add base address of buffer
0324   00D4           01238                 movwf   cpb_read_pointer                ; update cpb_read_pointer  
                      01239                 
0325                  01240 Creedbuftotxend
0325   178B           01241         bsf     INTCON, GIE             ; Enable interrupts     
0326   0008           01242         return
                      01243 
                      01244 
                      01245 ;******************************************************************
                      01246 ;*   BitBang hacked from
                      01247 ;*   Full Duplex Bit-Banged 9600 Baud Serial I/O Demo
                      01248 ;*   Mike McLaren, K8LH   (k8lh_at_arrl.net)
                      01249 ;*       http://www.piclist.com/techref/microchip/16F819-rs232-9600-mm.htm
                      01250 ;******************************************************************
                      01251 
                      01252 ;******************************************************************
                      01253 ;*                                                                *
                      01254 ;*    Interrupt Service Routine for a Full Duplex Bit-Banged      *
                      01255 ;*     Serial I/O                                         *
                      01256 ;*                                                                *
                      01257 ;*    Interrupts are generated at approximately 3 times the       *
                      01258 ;*    baud rate                                     *
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 32


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      01259 ;*                                                                *
                      01260 ;*    The transmit and receive processes are executed in the      *
                      01261 ;*    correct sequence each interrupt cycle by using a state      *
                      01262 ;*    machine variable and jump table for both RX and TX.         *
                      01263 ;*                                                                *
                      01264 ;*    After detecting a start bit, the receive bit stream is      *
                      01265 ;*    sampled every third interrupt cycle in the approximate      *
                      01266 ;*    middle third of each bit (between 33% and 66%).             *
                      01267 ;******************************************************************
                      01268 
                      01269 
0327                  01270 CRBBTxisr
                      01271 ;  enter the TX state machine
0327   3003           01272         movlw   HIGH CRBBTxtab
0328   008A           01273         movwf   PCLATH          ;select entry in the state machine depending on CRTX_SM
0329   084F           01274         movfw   CRTX_SM
Warning[202]: Argument out of range.  Least significant bits used.
032A   3E2E           01275         addlw   CRBBTxtab
032B   1803           01276         skpnc
032C   0A8A           01277         incf    PCLATH,f
032D   0082           01278         movwf   PCL
032E                  01279 CRBBTxtab
032E   2B43           01280         goto   CRTX_CHK         ;check if TX buffer is not empty and if so start the start bit 
032F   2B57           01281         goto   CRTX_NXT       ;
0330   2B57           01282         goto   CRTX_NXT          ;          
                      01283         
0331   2B51           01284         goto   CRTX_BIT          ; bit 1
0332   2B57           01285         goto   CRTX_NXT          ;               
0333   2B57           01286         goto   CRTX_NXT          ;               
0334   2B51           01287         goto   CRTX_BIT          ; bit 2         
0335   2B57           01288         goto   CRTX_NXT          ;            
0336   2B57           01289         goto   CRTX_NXT          ;            
0337   2B51           01290         goto   CRTX_BIT          ; bit 3       
0338   2B57           01291         goto   CRTX_NXT          ;           
0339   2B57           01292         goto   CRTX_NXT          ;            
033A   2B51           01293         goto   CRTX_BIT          ; bit 4       
033B   2B57           01294         goto   CRTX_NXT          ;             
033C   2B57           01295         goto   CRTX_NXT          ;             
033D   2B51           01296         goto   CRTX_BIT          ; bit 5      
033E   2B57           01297         goto   CRTX_NXT          ;             
033F   2B57           01298         goto   CRTX_NXT          ;            
                      01299                 ; stop bit is 1 period long
0340   2B4E           01300         goto   CRTX_STOP      ; start stop bit 
0341   2B57           01301         goto   CRTX_NXT          ;   
0342   2B59           01302         goto   CRTX_RES          ; last part of stop bit and reset 
                      01303 ;
                      01304 
                      01305 ;  if there's a transmit character buffered get it and start the state machine
0343   0852           01306 CRTX_CHK        movfw   creed_printer_data_full
0344   1903 2B4B      01307         bz      CRTX_CHK1
0346   0851           01308         movfw   creed_printer_data
0347   00CD           01309         movwf   CRTXWORK                ; put it in a work register
0348   3000           01310         movlw   false
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 33


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0349   00D2           01311         movwf   creed_printer_data_full
034A   2B4C           01312         goto    CRTX_STRT
                      01313         
034B                  01314 CRTX_CHK1
034B   0008           01315         return
                      01316         
                      01317 ; send the start bit
                      01318 CRTX_STRT       DoSpace                 ;send start bit
034C   1506               M         bsf     PORTB,creed_printer_data_bit
                      01319 
                      01320 ;;;; DEBUG       - pulse the motor control output for use on a scope
                      01321 ;       bsf     PORTB, creed_motor_bit
                      01322 ;       movlw   D'50'   ; 200 cycles - 400uS
                      01323 ;       movwf   Int_delay       ; including call/return
                      01324 ;idelayus1      decfsz  Int_delay,1     ; 2 uS per loop
                      01325 ;       goto    idelayus1  
                      01326 ;       bcf     PORTB, creed_motor_bit
                      01327         
034D   2B57           01328         goto    CRTX_NXT                ; increment TX state
                      01329 
                      01330 
                      01331 ;   send the stop bit
034E                  01332 CRTX_STOP       
                      01333         DoMark                  ; send stop bit  
034E   1106               M         bcf     PORTB,creed_printer_data_bit
034F   2B57           01334         goto    CRTX_NXT                ; increment TX state 
                      01335 
                      01336 ;  copy character from buffer to CRTXWORK after sending start bit
0350   2B57           01337 CRTX_BUF        goto    CRTX_NXT                ; increment TX state
                      01338 
                      01339 ;  transmit a bit
0351   0CCD           01340 CRTX_BIT        rrf     CRTXWORK,f
0352   1803           01341                 btfsc   STATUS,C                ; is it a '1'?
                      01342 CRTX_1  DoMark                  ; yes, send space
0353   1106               M         bcf     PORTB,creed_printer_data_bit
0354   1C03           01343                 btfss   STATUS,C                ; is it a '0'?
                      01344 CRTX_0  DoSpace                 ; yes, send mark
0355   1506               M         bsf     PORTB,creed_printer_data_bit
0356   2B57           01345         goto    CRTX_NXT                ; increment TX state
                      01346         
                      01347  ; increment the state machine       
0357   0ACF           01348 CRTX_NXT        incf    CRTX_SM,f       ; inc TX state machine
0358   0008           01349         return
                      01350 
                      01351 ;  reset TX state machine during final part of the stop bit
                      01352 
0359   01CF           01353 CRTX_RES        clrf    CRTX_SM ; reset TX state machine
035A   0008           01354                 return
                      01355 
                      01356 
                      01357 ; Read a character and put in Rx buffer
                      01358 
                      01359 
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 34


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

035B                  01360 CRBBRxisr
                      01361         
035B   3003           01362         movlw   HIGH CRBBRxtab
035C   008A           01363         movwf   PCLATH          ;select entry in the state machine depending on RX_SM
035D   0850           01364         movfw   CRRX_SM
Warning[202]: Argument out of range.  Least significant bits used.
035E   3E62           01365         addlw   CRBBRxtab
035F   1803           01366         skpnc
0360   0A8A           01367         incf    PCLATH,f
0361   0082           01368         movwf   PCL
                      01369 ; Rx state machine table
0362                  01370 CRBBRxtab  
0362   2B77           01371         goto    CRRX_CHK          ; RX idle      
0363   2B8A           01372         goto    CRRX_NXT          ; start bit     
0364   2B8A           01373         goto    CRRX_NXT          ; start bit     
0365   2B8A           01374         goto    CRRX_NXT          ;1              
0366   2B7A           01375         goto    CRRX_BIT          ; get bit 1 in middle of bit  
0367   2B8A           01376         goto    CRRX_NXT          ; 1       
0368   2B8A           01377         goto    CRRX_NXT          ; 2          
0369   2B7A           01378         goto    CRRX_BIT          ; get bit 2    
036A   2B8A           01379         goto    CRRX_NXT          ; 2         
036B   2B8A           01380         goto    CRRX_NXT          ; 3          
036C   2B7A           01381         goto    CRRX_BIT          ; get bit 3    
036D   2B8A           01382         goto    CRRX_NXT          ;3   
036E   2B8A           01383         goto    CRRX_NXT          ;4          
036F   2B7A           01384         goto    CRRX_BIT          ; get bit 4  
0370   2B8A           01385         goto    CRRX_NXT          ;4          
0371   2B8A           01386         goto    CRRX_NXT          ;5         
0372   2B7A           01387         goto    CRRX_BIT        ; get bit 5   
0373   2B7F           01388         goto    CRRX_BUF          ; 5 buffer  the data 
0374   2B8A           01389         goto    CRRX_NXT          ; stop 1            
0375   2B8A           01390         goto    CRRX_NXT          ; stop bit 1 
0376   2B86           01391         goto    CRRX_RES          ; stop bit, set buffer full flag and reset state machine
                      01392 
                      01393 
                      01394 ;  test for start bit (low
0377                  01395 CRRX_CHK        
0377   1A86           01396         btfsc   PORTB,creed_kb_data_bit           ; start bit?
0378   2B8A           01397         goto    CRRX_NXT
0379   0008           01398         return
                      01399 
                      01400 
                      01401 ;  receive a bit
037A   1003           01402 CRRX_BIT        bcf     STATUS,C
037B   1E86           01403         btfss   PORTB,creed_kb_data_bit ; is it a 0?
037C   1403           01404         bsf     STATUS,C                        ; no, make it a 1 in buffer
037D   0CCE           01405         rrf     CRRXWORK,f              ; shift into work byte
                      01406         
                      01407 ;;;; DEBUG      - pulse the motor control output for use on a scope
                      01408 ;       btfsc   PORTB,creed_kb_data_bit ; is it a 0?    
                      01409 ;       bsf     PORTB, creed_motor_bit
                      01410 ;       movlw   D'50'   ; 200 cycles - 400uS
                      01411 ;       movwf   Int_delay       ; including call/return
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 35


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      01412 ;idelayus1      decfsz  Int_delay,1     ; 2 uS per loop
                      01413 ;       goto    idelayus1  
                      01414 ;       bcf     PORTB, creed_motor_bit  
                      01415         
037E   2B8A           01416         goto    CRRX_NXT                        ; increment RX state
                      01417 
                      01418 
                      01419 ;  copy completed character in CRRXWORK byte to CRRXBUFF
037F                  01420 CRRX_BUF        
037F   0CCE           01421         rrf     CRRXWORK,f
0380   0CCE           01422         rrf     CRRXWORK,f
0381   0CCE           01423         rrf     CRRXWORK,f
0382   084E           01424         movfw   CRRXWORK                ; get completed work byte
                      01425         
0383   391F           01426         andlw   b'11111'
0384   00D7           01427         movwf   creed_kb_data           ; place it in the RX buffer
0385   2B8A           01428         goto    CRRX_NXT                ; increment RX state
                      01429 ;
                      01430 ; set  RX Buffer  full
0386                  01431 CRRX_RES        
0386   30FF           01432         movlw   true
0387   00D8           01433         movwf   creed_kb_data_full
0388   01D0           01434         clrf    CRRX_SM ; reset RX state machine
0389   0008           01435         return
                      01436 ;
                      01437 ; increment the RX  State machine
038A   0AD0           01438 CRRX_NXT        incf    CRRX_SM,f         ; inc RX state machine
038B   0008           01439         return
                      01440 
                      01441         
                      01442 ;  reset RX state machine after receiving a complete character
                      01443 ;  and during the last 3rd (66%-100%) of the stop bit to allow
                      01444 ;  setup time for detecting the next start bit
                      01445 ;       
                      01446 ;}
                      01447 ; TERMINAL UNIT 
                      01448 ;{
                      01449 ; Actually just the modulator and demodulator of a terminal unit.
                      01450 ;  initialize TU I/O and lock
                      01451 ;
038C   01C9           01452 ZTUinit clrf    tu_lock
038D   01CA           01453         clrf    tu_lock_state
                      01454 
038E   01BE           01455         clrf    TURX_SM         ; clr RX state machine 
038F   01BD           01456         clrf    TUTX_SM         ; clr TX state machine 
0390   3000           01457         movlw   false           ; character buffer empty
0391   00C2           01458         movwf   tu_mod_data_full
0392   30C0           01459         movlw   tu_mod_buffer
0393   00C3           01460         movwf   tumb_write_pointer              ;16 character buffer empty
0394   00C4           01461         movwf   tumb_read_pointer
                      01462 
                      01463         DoTUMark                                 ; send mark (idle to modulator)        
0395   1086               M         bcf     PORTB,mod_data_bit      
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 36


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0396   304C           01464         movlw   'L'             ;send letters shift
0397   00C5           01465         movwf   tu_mod_shift
0398   00C6           01466         movwf   tu_demod_shift
0399   301F           01467         movlw   .31
039A   23C9           01468         call    TUchar
039B   23C9           01469         call    TUchar
039C   3000           01470         movlw   false
039D   00C8           01471         movwf   tu_demod_data_full
039E   0008           01472         return
                      01473 
                      01474 
                      01475 
                      01476 ; Process the demodulator lock indication to produce a state variable for controlling the motor.
039F                  01477 TUlock
                      01478         ; Debounce the TU lock detection by moving the lock input into a shift register.
039F   1003           01479         bcf     STATUS,C
03A0   1C06           01480         btfss   PORTB,demod_lock_bit            ; is it a 0?
03A1   1403           01481         bsf     STATUS,C                        ; no, so set carry bit
03A2   0CC9           01482         rrf     tu_lock,f                       ; and shift into store
                      01483 
                      01484         
                      01485 ; control the TU lock state machine which is used to control the Creed Printer Motor
03A3   084A           01486         movfw   tu_lock_state
03A4   1903 2BAB      01487         bz      TUlock0 ;not locked
03A6   084A           01488         movfw   tu_lock_state
03A7   3C01           01489         sublw   .1
03A8   1903 2BB3      01490         bz      TUlock1 ;locked
03AA   2BBD           01491         goto    TUlock2 ;lock delay
                      01492         
                      01493 ;state 0 - no lock for past 2 second    
03AB                  01494 TUlock0         
03AB   0849           01495         movfw   tu_lock
03AC   3CFF           01496         sublw   h'FF'
03AD   1903 2BB0      01497         bz      TUlock01        ;lock detected
03AF   0008           01498         return          ;lock not detected, stay in this state
                      01499         
03B0   3001           01500 TUlock01        movlw   .1
03B1   00CA           01501         movwf   tu_lock_state   ;set state to lock detected
03B2   0008           01502         return
                      01503         
                      01504 ; state 1 - TU currently locked
03B3   0849           01505 TUlock1 movfw   tu_lock
03B4   3CFF           01506         sublw   h'ff'
03B5   1D03 2BB8      01507         bnz     TUlock11        ;lock not detected, start delay state 
03B7   0008           01508         return          ; otherwide stay in this state
                      01509 
03B8   3050           01510 TUlock11        movlw   .80     ;2 second delay
03B9   00E2           01511         movwf   tu_lock_timer
03BA   3002           01512         movlw   .2
03BB   00CA           01513         movwf   tu_lock_state
03BC   0008           01514         return
                      01515 
                      01516 
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 37


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      01517 ; state 2 - processing  lock delay
03BD   0849           01518 TUlock2 movfw   tu_lock
03BE   3CFF           01519         sublw   h'FF'
03BF   1903 2BC5      01520         bz      TUlock21                ;lock detected, abort timer and set lock detected state
03C1   0862           01521         movfw   tu_lock_timer   ; has delay ended
03C2   1903 2BC7      01522         bz      TUlock22                
03C4   0008           01523         return                  ;timer running, stay in this state              
                      01524 
03C5   01E2           01525 TUlock21        clrf    tu_lock_timer   ;lock detected during delay, abort timer and switch state
03C6   2BB0           01526         goto    TUlock01
                      01527 
                      01528 
03C7   01CA           01529 TUlock22        clrf    tu_lock_state   ;timer ended - set state to no lock                     
03C8   0008           01530         return
                      01531 
                      01532 
                      01533 
                      01534 
                      01535 ; TU modulator output is buffered twice
                      01536 ; First there is a 16 character buffer written to by TUchar. This is needed because some transmitting
                      01537 ; operations output two characters in quick succession.
                      01538 ; Secondly there is a single character tu_mod_data which is the interface between the base level and int
                            errupt level.
                      01539 ; The reason for this is to remove the need to manipulate pointers in the interrupt routine. It also giv
                            es an alternative way
                      01540 ; for base level tasks to send characters (but don't use both in the same program) 
                      01541 
                      01542 ; TUchar writes a character to the 16 character TU modulator buffer
                      01543 ; character is in W on entry and exit.
                      01544 
                      01545         
03C9                  01546 TUchar
03C9   00CB           01547         movwf   tuchar1         ; save character
03CA   0A43           01548         incf    tumb_write_pointer,W    ; is buffer full - W = WPTR + 1
03CB   390F           01549         andlw   h'0F'           ; keep it in range 00..0F
03CC   3EC0           01550         addlw   tu_mod_buffer   ; add buffer start address
03CD   00CC           01551         movwf   tuchar2         ; save pointer here temporarily for storing it
03CE   0644           01552         xorwf   tumb_read_pointer,W     ; buffer full (WPTR+1=RPTR)   
03CF   1903 2BD9      01553         bz      TUcharerror             ; buffer full so error
03D1   0843           01554         movfw   tumb_write_pointer      ; get TX buffer Wr ptr
03D2   0084           01555         movwf   FSR             ; setup indirect address
03D3   084B           01556         movfw   tuchar1         ; get character
03D4   0080           01557         movwf   INDF            ; place it in TX buffer
03D5   084C           01558                 movfw   tuchar2         ; get saved write pointer+1 value
03D6   00C3           01559         movwf   tumb_write_pointer      ; update write pointer
03D7   084B           01560         movfw   tuchar1         ; and place the character back in W     
03D8   0008           01561         return
                      01562         
03D9                  01563 TUcharerror     
03D9   138B           01564         bcf     INTCON, GIE             ; Disable interrupts
03DA   300A           01565         movlw   errTUbuf_h              ; and send error message to LCD
03DB   00DE           01566         movwf   tblptr_h
03DC   30B5           01567         movlw   errTUbuf_l
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 38


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

03DD   00DD           01568         movwf   tblptr_l
03DE   3005           01569         movlw   menu_err
03DF   00AF           01570         movwf   menu_state
03E0   2237           01571         call    LCDstatic
03E1   224F           01572         call    LCDhome
03E2   2225           01573         call    LCDstr  
03E3                  01574 TUcharerror1
03E3   2BE3           01575         goto    TUcharerror1
                      01576 
                      01577 
                      01578 ; emptying the long print buffer into the character buffer, need to disable interputs in this to prevent
                             race conditions
                      01579 
03E4                  01580 TUbuftotx
03E4   0844           01581         movfw   tumb_read_pointer       ;Anything to print?
03E5   0643           01582         xorwf   tumb_write_pointer,W       
03E6   1903 2BF6      01583         bz      TUbuftotxend    ; no so exit
03E8   138B           01584         bcf     INTCON, GIE             ; Disable interrupts
03E9   0842           01585         movfw   tu_mod_data_full         ;is creed busy printing
03EA   1D03 2BF6      01586         bnz     TUbuftotxend    ; yes so exit
03EC   0844           01587         movfw   tumb_read_pointer               ; get TX buffer Rd ptr
03ED   0084           01588         movwf   FSR             ; setup indirect address
03EE   0800           01589         movfw   INDF            ; get data
03EF   00C1           01590         movwf   tu_mod_data
03F0   30FF           01591         movlw   true
03F1   00C2           01592         movwf   tu_mod_data_full
03F2   0A44           01593         incf    tumb_read_pointer,W     ; W = cpb_read_pointer + 1 
03F3   390F           01594         andlw   h'0F'           ; keep in range 00..0F 
03F4   3EC0           01595         addlw   tu_mod_buffer   ; add base address of buffer
03F5   00C4           01596                 movwf   tumb_read_pointer               ; update cpb_read_pointer  
                      01597                 
03F6                  01598 TUbuftotxend
03F6   178B           01599                 BSF     INTCON, GIE     ; Enable interrupts     
03F7   0008           01600         return
                      01601 
                      01602 
                      01603 ;******************************************************************
                      01604 ;*   BitBang hacked from
                      01605 ;*   Full Duplex Bit-Banged 9600 Baud Serial I/O Demo
                      01606 ;*   Mike McLaren, K8LH   (k8lh_at_arrl.net)
                      01607 ;*       http://www.piclist.com/techref/microchip/16F819-rs232-9600-mm.htm
                      01608 ;******************************************************************
                      01609 
                      01610 ;******************************************************************
                      01611 ;*                                                                *
                      01612 ;*    Interrupt Service Routine for a Full Duplex Bit-Banged      *
                      01613 ;*     Serial I/O                                         *
                      01614 ;*                                                                *
                      01615 ;*    Interrupts are generated at approximately 3 times the       *
                      01616 ;*    baud rate                                     *
                      01617 ;*                                                                *
                      01618 ;*    The transmit and receive processes are executed in the      *
                      01619 ;*    correct sequence each interrupt cycle by using a state      *
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 39


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      01620 ;*    machine variable and jump table for both RX and TX.         *
                      01621 ;*                                                                *
                      01622 ;*    After detecting a start bit, the receive bit stream is      *
                      01623 ;*    sampled every third interrupt cycle in the approximate      *
                      01624 ;*    middle third of each bit (between 33% and 66%).             *
                      01625 ;******************************************************************
                      01626 
03F8                  01627 TUBBTxisr
                      01628 ;  enter the TX state machine
03F8   3003           01629         movlw   HIGH TUBBTxtab
03F9   008A           01630         movwf   PCLATH          ;select entry in the state machine depending onTUTX_SM
03FA   083D           01631         movfw   TUTX_SM
Warning[202]: Argument out of range.  Least significant bits used.
03FB   3EFF           01632         addlw   TUBBTxtab
03FC   1803           01633         skpnc
03FD   0A8A           01634         incf    PCLATH,f
03FE   0082           01635         movwf   PCL
03FF                  01636 TUBBTxtab
03FF   2C14           01637         goto   TUTX_CHK          ;check if TX buffer is not empty and if so send start bit  
0400   2C3E           01638         goto   TUTX_NXT                    
0401   2C3E           01639         goto   TUTX_NXT          ;          
                      01640         
0402   2C38           01641         goto   TUTX_BIT          ; bit 1
0403   2C3E           01642         goto   TUTX_NXT          ;               
0404   2C3E           01643         goto   TUTX_NXT          ;               
0405   2C38           01644         goto   TUTX_BIT          ; bit 2         
0406   2C3E           01645         goto   TUTX_NXT          ;            
0407   2C3E           01646         goto   TUTX_NXT          ;            
0408   2C38           01647         goto   TUTX_BIT          ; bit 3       
0409   2C3E           01648         goto   TUTX_NXT          ;           
040A   2C3E           01649         goto   TUTX_NXT          ;            
040B   2C38           01650         goto   TUTX_BIT          ; bit 4       
040C   2C3E           01651         goto   TUTX_NXT          ;             
040D   2C3E           01652         goto   TUTX_NXT          ;             
040E   2C38           01653         goto   TUTX_BIT          ; bit 5      
040F   2C3E           01654         goto   TUTX_NXT          ;             
0410   2C3E           01655         goto   TUTX_NXT          ;            
                      01656                 ; stop bit is 1 period long
0411   2C30           01657         goto   TUTX_STOP      ; start stop bit 
0412   2C3E           01658         goto   TUTX_NXT          ;
0413   2C40           01659         goto   TUTX_RES          ; last part of stop bit and reset 
                      01660 ;
                      01661 
                      01662 ;  if there's a transmit character buffered get it and increment the state machine
0414   0842           01663 TUTX_CHK        movfw   tu_mod_data_full
0415   1903 2C1C      01664         bz      TUTX_CHK1
0417   3000           01665         movlw   false
0418   00C2           01666         movwf   tu_mod_data_full
0419   0841           01667         movfw   tu_mod_data
041A   00BB           01668         movwf   TUTXWORK        ; put it in a work register
041B   2C23           01669         goto    TUTX_REV        
                      01670 
041C                  01671 TUTX_CHK1
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 40


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

041C   0838           01672         movfw   diddles         ;nothing to transit so send diddle if enabled
041D   1903 2C22      01673         bz      TUTX_CHK2
041F   301F           01674         movlw   .31
0420   00BB           01675         movwf   TUTXWORK        ;tu_mod_dada buffer is left indicating empty
0421   2C23           01676         goto    TUTX_REV
                      01677 
0422                  01678 TUTX_CHK2
0422   0008           01679         return
                      01680 
0423                  01681 TUTX_REV                                ;reverse the data
0423   0836           01682         movfw   TUreverse
0424   1903 2C28      01683         bz      TUTX_STRT
0426   09BB           01684         comf    TUTXWORK,f
0427   2C28           01685         goto    TUTX_STRT
                      01686 
                      01687 ; send the start bit
0428   0000           01688 TUTX_STRT nop
0429   0836           01689         movfw   TUreverse
042A   1D03 2C2E      01690         bnz     TUTX_STRT1
                      01691         DoTUSpace                       ; send start bit - normal
042C   1486               M         bsf     PORTB,mod_data_bit
042D   2C2F           01692         goto    TUTX_STRT2
042E                  01693 TUTX_STRT1
                      01694         DoTUMark                        ; or reverse
042E   1086               M         bcf     PORTB,mod_data_bit      
                      01695         
042F                  01696 TUTX_STRT2
                      01697                 
                      01698 ;;;; DEBUG - pulse the motor control output for use on a scope
                      01699 ;       bsf     PORTB, creed_motor_bit
                      01700 ;       movlw   D'50'   ; 200 cycles - 400uS
                      01701   ;     movwf   Int_delay       ; including call/return
                      01702 ;idelayus1      decfsz  Int_delay,1     ; 2 uS per loop
                      01703 ;       goto    idelayus1  
                      01704 ;       bcf     PORTB, creed_motor_bit  
                      01705 
042F   2C3E           01706         goto    TUTX_NXT                ; increment TX state
                      01707 
                      01708 
                      01709 ;   send the stop bit
0430                  01710 TUTX_STOP
0430   0836           01711         movfw   TUreverse
0431   1D03 2C35      01712         bnz     TUTX_STOP1      
                      01713         DoTUMark                        ; send stop bit   - normal
0433   1086               M         bcf     PORTB,mod_data_bit      
0434   2C3E           01714         goto    TUTX_NXT                ; increment TX state 
0435                  01715 TUTX_STOP1
                      01716         DoTUSpace
0435   1486               M         bsf     PORTB,mod_data_bit
0436   2C3E           01717         goto    TUTX_NXT
                      01718         
                      01719 
0437   2C3E           01720 TUTX_BUF        goto    TUTX_NXT                ; increment TX state
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 41


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      01721 
                      01722 ;  transmit a bit
                      01723 ; reversing is done on TUTXWORK
0438   0CBB           01724 TUTX_BIT        rrf     TUTXWORK,f
0439   1803           01725                 btfsc   STATUS,C                ; is it a '1'?
                      01726 TUTX_1  DoTUMark                        ; yes, send space
043A   1086               M         bcf     PORTB,mod_data_bit      
043B   1C03           01727                 btfss   STATUS,C                ; is it a '0'?
                      01728 TUTX_0  DoTUSpace                       ; yes, send mark
043C   1486               M         bsf     PORTB,mod_data_bit
043D   2C3E           01729         goto    TUTX_NXT                ; increment TX state
                      01730         
                      01731  ; increment the state machine       
043E   0ABD           01732 TUTX_NXT        incf    TUTX_SM,f               ; inc TX state machine
043F   0008           01733         return
                      01734 
                      01735 ;  reset TX state machine during final part of the stop bit
                      01736 
0440   01BD           01737 TUTX_RES        clrf    TUTX_SM ; reset TX state machine
0441   0008           01738                 return
                      01739 
                      01740 
                      01741 ; Read a character and put in Rx buffer
                      01742 
0442                  01743 TUBBRxisr
0442   3004           01744         movlw   HIGH TUBBRxtab
0443   008A           01745         movwf   PCLATH          ;select entry in the state machine depending on RX_SM
0444   083E           01746         movfw   TURX_SM
Warning[202]: Argument out of range.  Least significant bits used.
0445   3E49           01747         addlw   TUBBRxtab
0446   1803           01748         skpnc
0447   0A8A           01749         incf    PCLATH,f
0448   0082           01750         movwf   PCL
                      01751    
                      01752 ;  the RX state machine table
0449                  01753 TUBBRxtab  
0449   2C5E           01754         goto    TURX_CHK          ; RX idle      
044A   2C7C           01755         goto    TURX_NXT          ; start bit     
044B   2C7C           01756         goto    TURX_NXT          ; start        
044C   2C7C           01757         goto    TURX_NXT          ;1              
044D   2C67           01758         goto    TURX_BIT          ; get bit 1    
044E   2C7C           01759         goto    TURX_NXT          ; 1       
044F   2C7C           01760         goto    TURX_NXT          ; 2          
0450   2C67           01761         goto    TURX_BIT          ; get bit 2    
0451   2C7C           01762         goto    TURX_NXT          ; 2         
0452   2C7C           01763         goto    TURX_NXT          ; 3          
0453   2C67           01764         goto    TURX_BIT          ; get bit 3    
0454   2C7C           01765         goto    TURX_NXT          ;3   
0455   2C7C           01766         goto    TURX_NXT          ;4          
0456   2C67           01767         goto    TURX_BIT          ; get bit 4  
0457   2C7C           01768         goto    TURX_NXT          ;4          
0458   2C7C           01769         goto    TURX_NXT          ;5         
0459   2C67           01770         goto    TURX_BIT          ; get bit 5      
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 42


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

045A   2C6C           01771         goto    TURX_BUF          ; 5 buffer  the data 
045B   2C7C           01772         goto    TURX_NXT          ; stop 1            
045C   2C7C           01773         goto    TURX_NXT          ; stop bit 1 
045D   2C78           01774         goto    TURX_RES          ; stop bit, set buffer full flag and reset state machine
                      01775 
                      01776 
                      01777 ;  test for start bit (low for normal)
                      01778 
045E                  01779 TURX_CHK
045E   0836           01780         movfw   TUreverse
045F   1D03 2C64      01781         bnz     TURX_CHK1
0461   1A06           01782         btfsc   PORTB,demod_data_bit           ; start bit?
0462   2C7C           01783         goto    TURX_NXT
0463   0008           01784         return
0464                  01785 TURX_CHK1
0464   1E06           01786         btfss   PORTB,demod_data_bit           ; start bit (reversed)?
0465   2C7C           01787         goto    TURX_NXT
0466   0008           01788         return
                      01789 
                      01790 ;  receive a bit - reversing done on result of the character
0467   1003           01791 TURX_BIT        bcf     STATUS,C
0468   1E06           01792         btfss   PORTB,demod_data_bit            ; is it a 0?
0469   1403           01793         bsf     STATUS,C                        ; no, so 1 to byte
046A   0CBC           01794         rrf     TURXWORK,f              ; shift into our work byte      
046B   2C7C           01795         goto    TURX_NXT                        ; increment RX state
                      01796 
                      01797 
                      01798 ;  copy completed character in TURXWORK byte to TURXBUFF
046C                  01799 TURX_BUF        
046C   0CBC           01800         rrf     TURXWORK,f
046D   0CBC           01801         rrf     TURXWORK,f
046E   0CBC           01802         rrf     TURXWORK,f
046F   0836           01803         movfw   TUreverse               ;reversing needed?
0470   1D03 2C76      01804         bnz     TURX_BUF1       
0472                  01805 TURX_BUF2
0472   083C           01806         movfw   TURXWORK                ; get completed work byte
0473   391F           01807         andlw   b'11111'
0474   00C7           01808         movwf   tu_demod_data           ; place it in the RX buffer
0475   2C7C           01809         goto    TURX_NXT                ; increment RX state
                      01810 
0476                  01811 TURX_BUF1
0476   09BC           01812         comf    TURXWORK,f      ; do reversing  
0477   2C72           01813         goto    TURX_BUF2
                      01814 ;
                      01815 ; set  RX Buffer  full
0478                  01816 TURX_RES        
0478   30FF           01817         movlw   true
0479   00C8           01818         movwf   tu_demod_data_full
047A   01BE           01819         clrf    TURX_SM ; reset RX state machine
047B   0008           01820         return
                      01821 ;
                      01822 ; increment the RX  State machine
047C   0ABE           01823 TURX_NXT        incf    TURX_SM,f         ; inc RX state machine
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 43


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

047D   0008           01824         return
                      01825 
                      01826         
                      01827 ;  reset RX state machine after receiving a complete character
                      01828 ;  and during the last 3rd (66%-100%) of the stop bit to allow
                      01829 ;  setup time for detecting the next start bit
                      01830 ;       
                      01831 ;}
                      01832 
                      01833 
                      01834 ; DISCRETE I/O
                      01835 ;{
                      01836         
                      01837 ; This package handles the discrete I/O such as push buttons and relay control
                      01838 ; It does things like reading, debouncing and unpacking the inputs
                      01839 ;  and packing and sending the outputs
                      01840 ; The routines in the package are called every tick.  
                      01841         
                      01842         
047E                  01843 ZInitio
                      01844 
                      01845 ;INITIALISE I/O PORTS
                      01846 
                      01847 ; ************
                      01848 ; PORT A
                      01849 ; ************
                      01850 
                      01851 ;RA0-2 digital input
                      01852 ;RA3-5 not used
                      01853 ;RA6,RA7 oscillator (no control needed with XT mode.)
                      01854 
                      01855         Bank1
047E   1683               M         bsf STATUS, RP0
047F   1303               M         bcf STATUS, RP1
0480   3006           01856         MOVLW   0x06 ; Configure all pins
0481   009F           01857         MOVWF   ADCON1 ; as digital inputs
                      01858 
                      01859 ; Setup hardware port direction
                      01860 
0482   30FF           01861         movlw   b'11111111'     ;set all bits as inputs
0483   0085           01862         movwf   TRISA
                      01863         Bank0
0484   1283               M         bcf STATUS, RP0
0485   1303               M         bcf STATUS, RP1
                      01864 
                      01865 ; Init Digital Inputs
                      01866 ; RA0 - Tx, active low
                      01867 ; RA1  - InOk, Active Low
                      01868 ; RA2 - Next, Active low
0486   01E5           01869         clrf    inbuf_db_a              ; clear the debounce buffer
0487   1065           01870         bcf     inbuf_db_a, tx_bit      ; and set active low bits in debounce buffer
0488   14E5           01871         bsf     inbuf_db_a, inok_bit
0489   1565           01872         bsf     inbuf_db_a, next_bit
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 44


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      01873                 
048A   01A0           01874         clrf    tx              ; initialise decoded byte wide logicals
048B   01A9           01875         clrf    menu_inok_pressed
048C   01AC           01876         clrf    menu_next_pressed
                      01877 
                      01878 
                      01879         
                      01880 ; ************
                      01881 ; PORT B
                      01882 ; ************
                      01883 
                      01884 ; Inputs
                      01885 ; RB0 - demodulator lock - active low
                      01886 ; RB4 - demodulator data - 0 = high frequency = 0 volts = mark = idle, low frequency = +3 volts is space
                             
                      01887 ; RB5 - creed KB input - active high
                      01888 
                      01889 ; Outputs
                      01890 ; RB1 - modulator data - 1 ???   
                      01891 ; RB2 creed printer data 1 = +5 volts = mark = -80 volts = idle 0 = space 
                      01892 ; RB3 - creed motor control - active high
                      01893 
                      01894 ;RB6,7 ICSP
                      01895 
                      01896 ; Initialise Port B Outputs
                      01897         
048D   1086           01898         bcf     PORTB, mod_data_bit     
048E   1506           01899         bsf     PORTB, creed_printer_data_bit   ;set creed to mark
048F   1186           01900         bcf     PORTB, creed_motor_bit  ;turn off motor
                      01901         
                      01902 
                      01903 
                      01904 ;Setup Port B direction after setting initial port content
                      01905 
                      01906         Bank1
0490   1683               M         bsf STATUS, RP0
0491   1303               M         bcf STATUS, RP1
0492   1781           01907         bsf     OPTION_REG,NOT_RBPU  ; Disable PORTB pull-ups
0493   30F1           01908         movlw   b'11110001'     ;set direction
0494   0086           01909         movwf   TRISB
                      01910         Bank0
0495   1283               M         bcf STATUS, RP0
0496   1303               M         bcf STATUS, RP1
                      01911 
                      01912 ; Initialise PORT B input data
0497   01C7           01913         clrf    tu_demod_data
0498   01D7           01914         clrf    creed_kb_data
                      01915 
                      01916 
                      01917 
                      01918 ; *********
                      01919 ;PORTC
                      01920 ; *********
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 45


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      01921 ; digital outputs
                      01922 ; RC0 - RC3 LCD data
                      01923 ; RC4 LCD enable - active high
                      01924 ; RC5 LCD register select (0=control)
                      01925 
                      01926 ; RC6, RC7 reserved for UART
                      01927 
0499   0103           01928         clrw
049A   0087           01929         movwf   PORTC
                      01930 
                      01931 ; Initialise port C direction
                      01932                                 
                      01933         Bank1
049B   1683               M         bsf STATUS, RP0
049C   1303               M         bcf STATUS, RP1
049D   30C0           01934         movlw   b'11000000'     ;set I/O as above, UART bits must be inputs
049E   0087           01935         movwf   TRISC
                      01936         Bank0
049F   1283               M         bcf STATUS, RP0
04A0   1303               M         bcf STATUS, RP1
                      01937 
                      01938         
                      01939 ; Initialise PORT C inputs
                      01940 ; there are no discrete inputs on port C
                      01941 
04A1   0008           01942         return
                      01943 
04A2                  01944 ZReadinputs
                      01945 
                      01946 ; READ, DEBOUNCE, and DECODE  PORT A
                      01947 ; http://www.dattalo.com/technical/software/pic/debounce.html
                      01948 
04A2   0805           01949         movfw   PORTA
04A3   00E4           01950         movwf   inbuf_a
                      01951 
                      01952 ; debounce all bits even though only some are digital inputs
                      01953 
                      01954      ;Increment the vertical counter
04A4   0867           01955         MOVFw   count_B_a
04A5   06E6           01956         XORWF   count_A_a,F
04A6   09E7           01957         COMF    count_B_a,F
                      01958 
                      01959     ;See if any changes occurred
04A7   0864           01960         MOVFw   inbuf_a
04A8   0665           01961         XORWF   inbuf_db_a,W
                      01962 
                      01963     ;Reset the counter if no change has occurred
04A9   05E7           01964         ANDWF   count_B_a,F
04AA   05E6           01965         ANDWF   count_A_a,F
                      01966 
                      01967     ;If there is a pending change and the count has
                      01968     ;rolled over to 0, then the change has been filtered
04AB   3AFF           01969         XORLW   0xff            ;Invert the changes
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 46


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

04AC   0466           01970         IORWF   count_A_a,W       ;If count is 0, both A and B
04AD   0467           01971         IORWF   count_B_a,W       ;bits are 0
                      01972 
                      01973     ;Any bit in W that is clear at this point means that the input
                      01974     ;has changed and the count has rolled over.
04AE   3AFF           01975         XORLW   0xff
                      01976 
                      01977     ;Now W holds the state of inputs that have just been filtered
                      01978     ;to a new state. Update the changes:
04AF   06E5           01979         XORWF   inbuf_db_a,F
                      01980 
                      01981     ;finish with W indicating which bits have changed state after debounce.
04B0   00E8           01982         movwf   changed_a
                      01983 
                      01984 ; decode tx bit - active low
04B1   1865           01985         btfsc   inbuf_db_a, tx_bit
04B2   2CB5           01986         goto    Decodeporta1    ;bit set
04B3   3000           01987         movlw   false   ; receiving
04B4   2CB6           01988         goto    Decodeporta2
04B5                  01989 Decodeporta1    
04B5   30FF           01990         movlw   true    ; transmitting
04B6                  01991 Decodeporta2    
04B6   00A0           01992                 movwf   tx
                      01993 
                      01994 
                      01995 ; decode inok bit - active low
04B7   18E5           01996         btfsc   inbuf_db_a, inok_bit
04B8   2CBB           01997         goto    Decodeporta3    ;bit set
04B9   30FF           01998         movlw   true    ; bit clear - button pressed
04BA   2CBC           01999         goto    Decodeporta4
04BB   3000           02000 Decodeporta3    movlw   false   ; bit set - not pressed
04BC   00A9           02001 Decodeporta4    movwf   menu_inok_pressed
                      02002 
                      02003 ; decode next bit - active low
04BD   1965           02004         btfsc   inbuf_db_a, next_bit
04BE   2CC1           02005         goto    Decodeporta5    ;bit set
04BF   30FF           02006         movlw   true    ; bit clear - button pressed
04C0   2CC2           02007         goto    Decodeporta6
04C1   3000           02008 Decodeporta5    movlw   false   ; bit set - not pressed
04C2   00AC           02009 Decodeporta6    movwf   menu_next_pressed
                      02010 
                      02011 
                      02012 ; READ and DECODE  PORT B
                      02013 
                      02014 ; nothing to do
                      02015 ; READ and DECODE  PORT C
                      02016 
                      02017 ; nothing to do - LCD and USART
                      02018 
04C3   0008           02019         return
                      02020 
                      02021 
04C4                  02022 ZSendoutputs
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 47


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      02023 
                      02024 ; encode and send the outputs
                      02025 ; for each port look at the byte wide variables and pack them into the output buffer.
                      02026 ; Byte wide variables use standard true/false but hardware outputs may be active high or active low.
                      02027 ; Finally send the content of the output buffer to the port.
                      02028 
                      02029 ;PORT A - no outputs
                      02030 
                      02031 ; PORT B
                      02032 ; nothing
                      02033 
                      02034 ; PORT C
                      02035 
                      02036 ;Nothing
                      02037 
04C4                  02038 Sendoutputend
04C4   0008           02039         return
                      02040 ;}
                      02041 
                      02042 
                      02043 ;MODES
                      02044 ;{
                      02045         
04C5                  02046 ZModesinit
04C5   223B           02047         call    LCDscroll       ;initialise  LCD scrolling
                      02048 
04C6                  02049 ZModes
                      02050 ; The subroutines here glue together the input and output serial interfaces by reading a character from 
                            an input
                      02051 ; processing it and sending the result to an output.
                      02052 ; Which routines are called and what they do depends on the transfer mode.
                      02053 ; In some modes the transfer depends whether we are receiving or transmitting.
                      02054 ; if we are in a menu then transfers do not take place
                      02055 ; In most modes the received characters are also sent to the LCD display where they scroll across the sc
                            reen
                      02056 
                      02057 ; select transfer mode depending on configuration data
04C6   082F           02058         movfw   menu_state
04C7   1D03 2CEE      02059         bnz     modeskip
04C9   0834           02060         movfw   mode
04CA   1903 2CF0      02061         bz      Modeweather
04CC   3C01           02062         sublw   .1
04CD   1903 2D10      02063         bz      ModeTUtoCreed
04CF   0834           02064         movfw   mode
04D0   3C02           02065         sublw   .2
04D1   1903 2D56      02066         bz      ModeTUtoPC
04D3   0834           02067         movfw   mode
04D4   3C03           02068         sublw   .3
04D5   1903 2DD9      02069         bz      ModePCtoCreed
04D7   0834           02070         movfw   mode
04D8   3C04           02071         sublw   .4
04D9   1903 2DAC      02072         bz      Modecreedloop
04DB   0834           02073         movfw   mode
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 48


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

04DC   3C05           02074         sublw   .5
04DD   1903 2D5D      02075         bz      ModeTUloop
04DF   0834           02076         movfw   mode
04E0   3C06           02077         sublw   .6
04E1   1903 2DC4      02078         bz      ModePCloop
04E3   2DD9           02079         goto    ModePCtoCreed
                      02080 
04E4   300A           02081         movlw   errmode_h               ;erroneous mode
04E5   00DE           02082         movwf   tblptr_h
04E6   30D9           02083         movlw   errmode_l
04E7   00DD           02084         movwf   tblptr_l
04E8   3005           02085         movlw   menu_err
04E9   00AF           02086         movwf   menu_state
04EA   2237           02087         call    LCDstatic
04EB   224F           02088         call    LCDhome
04EC   2225           02089         call    LCDstr          
04ED   2CED           02090 help1   goto    help1   ;erroneouse mode number
                      02091         
                      02092 modeskip        Domotoroff              ;in menu turn off motor
04EE   1186               M         bcf     PORTB,creed_motor_bit
04EF   0008           02093         return
                      02094 
                      02095 ; -------------------------------------------------------------------------
04F0                  02096 Modeweather                     
                      02097 ; Receiving weather from TU to Creed, no transmit in this mode
                      02098 ;Tx/Rx switch turns the printer on.
                      02099 
                      02100 
04F0   0820           02101         movfw   tx              ;turn on motor if Tx switch is on.
04F1   1903 2CF5      02102         bz      Modeweather3
                      02103         Domotoron
04F3   1586               M         bsf     PORTB,creed_motor_bit
04F4   2CF6           02104         goto    Modeweather2
04F5                  02105 Modeweather3
                      02106         Domotoroff      
04F5   1186               M         bcf     PORTB,creed_motor_bit
04F6                  02107 Modeweather2
04F6   0848           02108         movfw   tu_demod_data_full
04F7   1903 2D0F      02109         bz      Modeweatherend  ; nothing to receive
04F9   0820           02110         movfw   tx              ;print char if Tx switch is set
04FA   1903 2CFE      02111         bz      Modeweather1
                      02112 ;       nop     
04FC   0847           02113         movfw   tu_demod_data
04FD   22F8           02114         call    Creedchar               
04FE                  02115 Modeweather1
04FE   0846           02116         movfw   tu_demod_shift  ;convert character to ASCII
04FF   00EF           02117         movwf   cc_temp_shift
0500   0847           02118         movfw   tu_demod_data   
0501   2136           02119         call    Ccitoa
0502   00E9           02120         movwf   modes1
0503   3C1B           02121         sublw   h'1b'           ;ignore escape returned after shift change
0504   1903 2D0B      02122         bz      Modeweather4
0506   0869           02123         movfw   modes1          
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 49


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0507   2268           02124         call    LCDchar         ; and display on LCD
0508   2242           02125         call    LCDshift
0509   0869           02126         movfw   modes1
050A   229C           02127         call    USARTchar               ;and send to PC
050B                  02128 Modeweather4    
050B   086F           02129         movfw   cc_temp_shift
050C   00C6           02130         movwf   tu_demod_shift          
050D   3000           02131         movlw   false
050E   00C8           02132         movwf   tu_demod_data_full
050F                  02133 Modeweatherend
                      02134         
050F   0008           02135         return
                      02136 ; -------------------------------------------------------------------------
0510                  02137 ModeTUtoCreed
0510   0820           02138         movfw   tx
0511   1D03 2D3E      02139         bnz     ModeTUtoCreedtx
                      02140                         
                      02141 ; Receiving from TU to Creed
0513                  02142 ModeTUtoCreedrx
                      02143                                 ; motor is on or if autostart then controlled by lock
0513   0839           02144         movfw   autostart
0514   1903 2D1B      02145         bz      ModeTUtoCreedrx3
0516   084A           02146         movfw   tu_lock_state   ; autostart
0517   1903 2D1B      02147         bz      ModeTUtoCreedrx3        ; no lock so motor off
                      02148         Domotoron
0519   1586               M         bsf     PORTB,creed_motor_bit
051A   2D1C           02149         goto    ModeTUtoCreedrx2
                      02150         
051B                  02151 ModeTUtoCreedrx3
                      02152         Domotoroff
051B   1186               M         bcf     PORTB,creed_motor_bit
                      02153 
051C                  02154 ModeTUtoCreedrx2
051C   0848           02155         movfw   tu_demod_data_full
051D   1903 2D3D      02156         bz      ModeTUtoCreedrxend      ; nothing to receive
051F   0847           02157         movfw   tu_demod_data
0520   22F8           02158         call    Creedchar               ;and print it
                      02159         
                      02160                                 ; in USOS on and if it was a space then change system to letters shift a
                            nd 
                      02161                                 ; send a letters shift to the creed
0521   083A           02162         movfw   USOS
0522   1903 2D2C      02163         bz      ModeTUtoCreedrx1                        
0524   0847           02164         movfw   tu_demod_data
0525   3C04           02165         sublw   .4
0526   1903 2D2C      02166         bz      ModeTUtoCreedrx1
0528   301F           02167         movlw   .31
0529   22F8           02168         call    Creedchar
052A   304C           02169         movlw   'L'
052B   00C6           02170         movwf   tu_demod_shift
                      02171         
052C                  02172 ModeTUtoCreedrx1        
052C   0846           02173         movfw   tu_demod_shift  ;convert character to ASCII
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 50


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

052D   00EF           02174         movwf   cc_temp_shift
052E   0847           02175         movfw   tu_demod_data   
052F   2136           02176         call    Ccitoa
0530   00E9           02177         movwf   modes1
0531   3C1B           02178         sublw   h'1b'           ;ignore escape returned after shift change
0532   1903 2D39      02179         bz      ModeTUtoCreedrx4
0534   0869           02180         movfw   modes1          
0535   2268           02181         call    LCDchar         ; and display on LCD
0536   2242           02182         call    LCDshift
0537   0869           02183         movfw   modes1
0538   229C           02184         call    USARTchar               ;and send to PC
0539                  02185 ModeTUtoCreedrx4        
0539   086F           02186         movfw   cc_temp_shift
053A   00C6           02187         movwf   tu_demod_shift          
053B   3000           02188         movlw   false
053C   00C8           02189         movwf   tu_demod_data_full
053D                  02190 ModeTUtoCreedrxend
                      02191         
053D   0008           02192         return
                      02193         
                      02194         
                      02195 ; Transmitting from Creed KB to TU
053E                  02196 ModeTUtoCreedtx
                      02197         Domotoron
053E   1586               M         bsf     PORTB,creed_motor_bit
                      02198         
053F   0858           02199         movfw   creed_kb_data_full
0540   1903 2D55      02200         bz      ModeTUtoCreedtxend      ; nothing to send
0542   0857           02201         movfw   creed_kb_data   ;get character from KB
0543   23C9           02202         call    TUchar          ; and send it to the modulator
                      02203         
0544   0859           02204         movfw   creed_kb_shift  ; display it on LCD
0545   00EF           02205         movwf   cc_temp_shift
0546   0857           02206         movfw   creed_kb_data
0547   2136           02207         call    Ccitoa          ;convert character to ASCII
0548   00E9           02208         movwf   modes1
0549   3C1B           02209         sublw   h'1b'           ;ignore escape returned after shift change
054A   1903 2D51      02210         bz      ModeTUtoCreedtx1
054C   0869           02211         movfw   modes1
054D   2268           02212         call    LCDchar         ;display on LCD
054E   2242           02213         call    LCDshift
054F   0869           02214         movfw   modes1
0550   229C           02215         call    USARTchar               ;and send it to the PC
0551                  02216 ModeTUtoCreedtx1
0551   086F           02217         movfw   cc_temp_shift
0552   00D9           02218         movwf   creed_kb_shift
0553   3000           02219         movlw   false
0554   00D8           02220         movwf   creed_kb_data_full
0555                  02221 ModeTUtoCreedtxend
0555   0008           02222         return
                      02223 ; ---------------------------------------------------------------------------
                      02224 ; TU TO PC
                      02225 ;Remote = TU -  Local = PC
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 51


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      02226 
0556                  02227 ModeTUtoPC
0556   0820           02228         movfw   tx
0557   1D03 2D5B      02229         bnz     ModeTUtoPC1     
0559   2560           02230         call    ModeTUtoPCrx
055A   0008           02231         return  
055B                  02232 ModeTUtoPC1
055B   257F           02233         call    ModeTUtoPCtx
055C   0008           02234         return
                      02235         
                      02236 ; -------------------------------------------------------------------------------
                      02237 ; TU Loop
                      02238 ; PC to TU and TU to PC 
                      02239         
055D                  02240 ModeTUloop 
055D   2560           02241         call    ModeTUtoPCrx
055E   257F           02242         call    ModeTUtoPCtx
055F   0008           02243         return
                      02244 
                      02245 ;                       
                      02246 ; Receiving from TU to PC
                      02247 
0560                  02248 ModeTUtoPCrx
                      02249         Domotoroff
0560   1186               M         bcf     PORTB,creed_motor_bit
0561   0848           02250         movfw   tu_demod_data_full
0562   1903 2D7E      02251         bz      ModeTUtoPCrxend ; nothing to receive
                      02252                                 ; convert the character to ascii
                      02253                                 
0564   0846           02254         movfw   tu_demod_shift          ;get current state of demodulator shift
0565   00EF           02255         movwf   cc_temp_shift           
0566   0847           02256         movfw   tu_demod_data   ;convert character to ASCII
0567   2136           02257         call    Ccitoa          
0568   00E9           02258         movwf   modes1
0569   3C1B           02259         sublw   h'1b'           ;ignore escape returned after shift change
056A   1903 2D71      02260         bz      ModeTUtoPCrx2
056C   0869           02261         movfw   modes1
056D   2268           02262         call    LCDchar
056E   2242           02263         call    LCDshift
056F   0869           02264         movfw   modes1
0570   229C           02265         call    USARTchar               ;and print it
0571                  02266 ModeTUtoPCrx2   
0571   086F           02267         movfw   cc_temp_shift
0572   00C6           02268         movwf   tu_demod_shift          ;save current state of demodulator shift
                      02269         
                      02270                                 ; in USOS on and if it was a space then change system to letters shift a
                            nd 
                      02271                                 ; send a letters shift to the creed
0573   083A           02272         movfw   USOS
0574   1903 2D7C      02273         bz      ModeTUtoPCrx1                   
0576   0847           02274         movfw   tu_demod_data
0577   3C04           02275         sublw   .4
0578   1903 2D7C      02276         bz      ModeTUtoPCrx1
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 52


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

057A   304C           02277         movlw   'L'
057B   00C6           02278         movwf   tu_demod_shift
                      02279 
057C                  02280 ModeTUtoPCrx1
057C   3000           02281         movlw   false
057D   00C8           02282         movwf   tu_demod_data_full
                      02283         
057E                  02284 ModeTUtoPCrxend
057E   0008           02285         return
                      02286         
                      02287         
                      02288 ; Transmit  from PC to TU
                      02289 ; Get a character from PC, display it on the LCD convert it, send shift if required
                      02290 
057F                  02291 ModeTUtoPCtx
                      02292         Domotoroff
057F   1186               M         bcf     PORTB,creed_motor_bit
0580   0822           02293         movfw   usart_rx_data_full      ;test for a character from USART
0581   1903 2DAB      02294         bz      ModeTUtoPCtxend ; nothing to send
0583   0821           02295         movfw   usart_rx_data
0584   2268           02296         call    LCDchar
0585   2242           02297         call    LCDshift
0586   0821           02298         movfw   usart_rx_data
0587   2129           02299         call    Ccatoi          ;convert character to ita2
0588   00E9           02300         movwf   modes1
0589   3C55           02301         sublw   'U'
058A   1903 2DA9      02302         bz      ModeTUtoPCtxclr ;character is not in Creed set so ignore
058C   0869           02303         movfw   modes1
058D   3C42           02304         sublw   'B'
058E   1903 2D9D      02305         bz      ModeTUtoPCtx1   ;shift does not matter so just print the char
0590   0869           02306         movfw   modes1
0591   0245           02307         subwf   tu_mod_shift,w
0592   1903 2D9D      02308         bz      ModeTUtoPCtx1   ;shift same as last time so just print
0594   0869           02309         movfw   modes1
0595   00C5           02310         movwf   tu_mod_shift    ;store current shift in last
0596   3C4C           02311         sublw   'L'
0597   1903 2D9B      02312         bz      ModeTUtoPCtx2   ;send LTRS shift
0599   301B           02313         movlw   .27             ;figs
059A   2D9C           02314         goto    ModeTUtoPCtx3   
059B                  02315 ModeTUtoPCtx2
059B   301F           02316         movlw   .31             ;or LTRS shift
059C                  02317 ModeTUtoPCtx3
059C   23C9           02318         call    TUchar          ;and print shift
                      02319                         
059D                  02320 ModeTUtoPCtx1
059D   0837           02321         movfw   PCcrlf          ;is auto LF option on
059E   1903 2DA6      02322         bz      ModeTUtoPCtx4   ;no so just print the character         
05A0   0870           02323         movfw   ITA2char                ; is char a CR
05A1   3C08           02324         sublw   .8
05A2   1D03 2DA6      02325         bnz     ModeTUtoPCtx4   ;no
05A4   3002           02326         movlw   .2
05A5   23C9           02327         call    TUchar          ; yes so send LF before CR
                      02328 
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 53


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

05A6                  02329 ModeTUtoPCtx4
05A6   0870           02330         movfw   ITA2char        
05A7   23C9           02331         call    TUchar  ;and print it
05A8   0000           02332         nop
                      02333         
05A9                  02334 ModeTUtoPCtxclr 
05A9   3000           02335         movlw   false
05AA   00A2           02336         movwf   usart_rx_data_full
05AB                  02337 ModeTUtoPCtxend 
05AB   0008           02338         return          
                      02339 
                      02340 ; -------------------------------------------------------------
                      02341 
                      02342 ; CREED LOOP
                      02343 
                      02344 ; local loop from Creed kb to Creed Printer
                      02345 
05AC                  02346 Modecreedloop
                      02347         Domotoron
05AC   1586               M         bsf     PORTB,creed_motor_bit
05AD   0858           02348         movfw   creed_kb_data_full
05AE   1903 2DC3      02349         bz      Modecreedloopend        ; nothing to send
05B0   0857           02350         movfw   creed_kb_data
05B1   22F8           02351         call    Creedchar               ;and print it
05B2   0859           02352         movfw   creed_kb_shift  ;convert character to ASCII
05B3   00EF           02353         movwf   cc_temp_shift
05B4   0857           02354         movfw   creed_kb_data   
05B5   2136           02355         call    Ccitoa
05B6   00E9           02356         movwf   modes1
05B7   3C1B           02357         sublw   h'1b'           ;ignore escape returned after shift change
05B8   1903 2DBF      02358         bz      Modecreedloop1
05BA   0869           02359         movfw   modes1  
05BB   2268           02360         call    LCDchar         ; and display on LCD
05BC   2242           02361         call    LCDshift
05BD   0869           02362         movfw   modes1
05BE   229C           02363         call    USARTchar               ;and send it to the PC  
05BF                  02364 Modecreedloop1
05BF   086F           02365         movfw   cc_temp_shift
05C0   00D9           02366         movwf   creed_kb_shift  
05C1   3000           02367         movlw   false
05C2   00D8           02368         movwf   creed_kb_data_full
05C3                  02369 Modecreedloopend
05C3   0008           02370         return
                      02371 
                      02372 ; loop around the PC, primarily for test purposes       
05C4                  02373 ModePCloop 
                      02374         Domotoroff
05C4   1186               M         bcf     PORTB,creed_motor_bit
05C5   0822           02375         movfw   usart_rx_data_full      ;test for a character from USART
05C6   1903 2DD8      02376         bz      ModePCloopend   ; nothing to send
05C8   0821           02377         movfw   usart_rx_data
05C9   2268           02378         call    LCDchar         ;send character to LCD
05CA   2242           02379         call    LCDshift
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 54


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

05CB   0837           02380         movfw   PCcrlf          ;is auto LF option on
05CC   1903 2DD4      02381         bz      ModePCloop1     ;no so just print the character         
05CE   0821           02382         movfw   usart_rx_data
05CF   3C0D           02383         sublw   h'0d'           ;is character CR
05D0   1D03 2DD4      02384         bnz     ModePCloop1     ;no
05D2   300A           02385         movlw   h'0a'
05D3   229C           02386         call    USARTchar               ; yes so send LF before CR
05D4                  02387 ModePCloop1     
05D4   0821           02388         movfw   usart_rx_data
05D5   229C           02389         call    USARTchar               ;and print the character        
05D6   3000           02390         movlw   false
05D7   00A2           02391         movwf   usart_rx_data_full
05D8                  02392 ModePCloopend   
05D8   0008           02393         return
                      02394 
                      02395 ; ------------------------------------------------------------
                      02396 
                      02397 ; PC TO CREED
                      02398 
                      02399 ;Remote = PC. Local = Creed
05D9                  02400 ModePCtoCreed
05D9   0820           02401         movfw   tx
05DA   1903 2DF2      02402         bz      ModePCtoCreedrx
                      02403                         
                      02404 ; Transmitting from Creed KB to PC
05DC                  02405 ModePCtoCreedtx
                      02406         Domotoron
05DC   1586               M         bsf     PORTB,creed_motor_bit
05DD   0858           02407         movfw   creed_kb_data_full
05DE   1903 2DF1      02408         bz      ModePCtoCreedtxend      ; nothing to send
05E0   0859           02409         movfw   creed_kb_shift
05E1   00EF           02410         movwf   cc_temp_shift
05E2   0857           02411         movfw   creed_kb_data
05E3   2136           02412         call    Ccitoa          ;convert character to ASCII
05E4   00E9           02413         movwf   modes1
05E5   3C1B           02414         sublw   h'1b'           ;ignore escape returned after shift change
05E6   1903 2DED      02415         bz      ModePCtoCreedtx1
05E8   0869           02416         movfw   modes1  
05E9   2268           02417         call    LCDchar
05EA   2242           02418         call    LCDshift
05EB   0869           02419         movfw   modes1
05EC   229C           02420         call    USARTchar               ;and print it
05ED                  02421 ModePCtoCreedtx1                
05ED   086F           02422         movfw   cc_temp_shift
05EE   00D9           02423         movwf   creed_kb_shift
05EF   3000           02424         movlw   false
05F0   00D8           02425         movwf   creed_kb_data_full
05F1                  02426 ModePCtoCreedtxend
05F1   0008           02427         return
                      02428         
                      02429         
                      02430 ; Receiving  from PC to Creed Printer
                      02431 ; Get a character from PC, display it on the LCD convert it, send shift if required
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 55


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      02432 
05F2                  02433 ModePCtoCreedrx
                      02434         Domotoron
05F2   1586               M         bsf     PORTB,creed_motor_bit
05F3   0822           02435         movfw   usart_rx_data_full      ;test for a character from USART
05F4   1903 2E1E      02436         bz      ModePCtoCreedrxend      ; nothing to send
05F6   0821           02437         movfw   usart_rx_data
05F7   2268           02438         call    LCDchar
05F8   2242           02439         call    LCDshift
05F9   0821           02440         movfw   usart_rx_data
05FA   2129           02441         call    Ccatoi          ;convert character to ita2
05FB   00E9           02442         movwf   modes1
05FC   3C55           02443         sublw   'U'
05FD   1903 2E1C      02444         bz      ModePCtoCreedrxclr      ;character is not in Creed set so ignore
05FF   0869           02445         movfw   modes1
0600   3C42           02446         sublw   'B'
0601   1903 2E10      02447         bz      ModePCtoCreedrx1        ;shift does not matter so just print the char
0603   0869           02448         movfw   modes1
0604   025A           02449         subwf   creed_printer_shift,w
0605   1903 2E10      02450         bz      ModePCtoCreedrx1        ;shift same as last time so just print
0607   0869           02451         movfw   modes1
0608   00DA           02452         movwf   creed_printer_shift     ;store current shift in last
0609   3C4C           02453         sublw   'L'
060A   1903 2E0E      02454         bz      ModePCtoCreedrx2        ;send LTRS shift
060C   301B           02455         movlw   .27             ;figs
060D   2E0F           02456         goto    ModePCtoCreedrx3        
060E                  02457 ModePCtoCreedrx2
060E   301F           02458         movlw   .31             ;or LTRS shift
060F                  02459 ModePCtoCreedrx3
060F   22F8           02460         call    Creedchar               ;and print shift
                      02461                         
0610                  02462 ModePCtoCreedrx1
0610   0837           02463         movfw   PCcrlf          ;is auto LF option on
0611   1903 2E19      02464         bz      ModePCtoCreedrx4        ;no so just print the character         
0613   0870           02465         movfw   ITA2char                ; is char a CR
0614   3C08           02466         sublw   .8
0615   1D03 2E19      02467         bnz     ModePCtoCreedrx4        ;no
0617   3002           02468         movlw   .2
0618   22F8           02469         call    Creedchar               ; yes so send LF before CR
                      02470 
0619                  02471 ModePCtoCreedrx4
0619   0870           02472         movfw   ITA2char        
061A   22F8           02473         call    Creedchar       ;and print it
061B   0000           02474         nop
                      02475         
061C                  02476 ModePCtoCreedrxclr      
061C   3000           02477         movlw   false
061D   00A2           02478         movwf   usart_rx_data_full
061E                  02479 ModePCtoCreedrxend      
061E   0008           02480         return          
                      02481 
                      02482 
                      02483 ;}
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 56


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      02484 
                      02485 ; TIMERS
                      02486 ;{
                      02487 
061F                  02488 ZTimersinit
                      02489 
061F   301C           02490         movlw   tick_counter_period     ; start 700mS tick counter
0620   00E3           02491         movwf   tick_counter
                      02492 
0621   3000           02493         movlw   0       ; timers off
0622   00E1           02494         movwf   menu_timer
0623   0008           02495         return
                      02496 
                      02497 
0624                  02498 ZTimers
                      02499 
                      02500 ; Callled every tick
                      02501 ; Put 25mS increment Timers here
0624   0862           02502         movfw   tu_lock_timer   ;is TU lock timer runnning
0625   1903 2E28      02503         bz      Timers700
0627   03E2           02504         decf    tu_lock_timer,f ; yes so increment it
                      02505 
                      02506 
0628                  02507 Timers700
                      02508 ; increment the 25ms. tick to produce a 700mS tick
0628   0BE3           02509         decfsz  tick_counter,f  ;decrement tick counter
0629   2E30           02510         goto    Timersend               ; not zero so do nothing
                      02511 ;timer is zero - reset it and do 700ms timers
062A   301C           02512         movlw   tick_counter_period
062B   00E3           02513         movwf   tick_counter
                      02514 
                      02515 ; Do 700mS timers
                      02516 ; descrement timers if running
062C   0861           02517         movfw   menu_timer              ;is menu_timer runnning
062D   1903 2E30      02518         bz      Timersend
062F   03E1           02519         decf    menu_timer,f    ; yes so decrement it
                      02520         
0630                  02521 Timersend
0630   0008           02522         return
                      02523 ;}
                      02524 
                      02525 
                      02526 
                      02527 ; KERNEL
                      02528 ;{
                      02529 
                      02530 ;; HOW THE KERNEL WORKS
                      02531 ;;; *********************************
                      02532 ; The kernel has and interrupt routine and a base level loop.
                      02533 ; The interrupt routine is single level - interrupts cannot interrupt other interrupts.
                      02534 ; Interrupt routines are inttended for hard real time responses. They should do the minimum of processin
                            g
                      02535 ; and then set signals which are detected in the base level loop where non hard real time processing is 
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 57


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                            carried out.
                      02536 ; Signals are a  general term which covers things generated by both hardware and software.
                      02537 ;  Applicatrion tasks need to reset signals
                      02538 
                      02539 ; The base level loop is executed continuously. Tasks to be carried out in the base level loop are calle
                            d as subroutine
                      02540 ; calls of the suroutine Baseloop.
                      02541 
                      02542 ;Tasks typically test for a signal and execute the required code. Other than for very short delays base 
                            level tasks
                      02543 ; should not wait by looping. They should test for a signal and if there is nothing to do exit back to t
                            he kernel
                      02544 
                      02545 ; There is one inbuilt base level task called Tick. Tick polls the Timer 0 interrupt flag (which does no
                            t cause and interrupt)
                      02546 ; and executes tasks implemented by subroutine calls put in the subroutine Tick. Like all other tasks th
                            ese task should not wait by looping.
                      02547 ; Timer0 is current;y set to 25mS whch is a good speed for debouncing.
                      02548 
                      02549 ; There are three pre-defined tasks in Tick:
                      02550 ; Timers - Provides a slower tick - 700mS - and is a place to put code to implement slower timers for th
                            ings like blinking LED's
                      02551 ; The timers result in signals which are tested by applicatrion taks.
                      02552 ; Readinputs - reads discrete inputs from the Ports, debounces and unpacks them
                      02553 ; Sendoutputs - packs discrete outputs ans sends them to the ports.
                      02554 
                      02555 ; There is a subroutine call Init in which calls to subroutines to initialise things should be placed. I
                            nit is executed
                      02556 ; before interrupts are enabled and the base level loop is entered.
                      02557  
                      02558 ; **************************************
                      02559 
                      02560 
                      02561 ; Initialise the kernel and call routines to initialise the application tasks
                      02562 
0631   0000           02563 ZMain   nop
0632   0064           02564         clrwdt
                      02565 
                      02566         Bank0           ; disable all interrupts
0633   1283               M         bcf STATUS, RP0
0634   1303               M         bcf STATUS, RP1
0635   018B           02567         clrf    INTCON
                      02568         Bank1
0636   1683               M         bsf STATUS, RP0
0637   1303               M         bcf STATUS, RP1
0638   018C           02569         clrf    PIE1    ; Disable peripheral interrupts
                      02570         Bank0
0639   1283               M         bcf STATUS, RP0
063A   1303               M         bcf STATUS, RP1
063B   018C           02571         clrf    PIR1    ; Clear peripheral interrupts Flags     
                      02572 
063C   209C           02573         call    ZReadconfig     ;get the configuration data from EEPROM
                      02574 
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 58


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

063D   26A5           02575         call    ZInit   ; Initialise the application tasks
                      02576         
063E   2237           02577         call    LCDstatic
063F   224F           02578         call    LCDhome
0640   3008           02579         movlw   welstr_h                ;display welcomemessage on LCD
0641   00DE           02580         movwf   tblptr_h
0642   3015           02581         movlw   welstr_l
0643   00DD           02582         movwf   tblptr_l
0644   2225           02583         call    LCDstr
0645   30FF           02584         movlw   .255    ;display message for 1 seconds
0646   21DD           02585         call    delaywms
0647   30FF           02586         movlw   .255    
0648   21DD           02587         call    delaywms
0649   30FF           02588         movlw   .255    
064A   21DD           02589         call    delaywms
064B   30FF           02590         movlw   .255    
064C   21DD           02591         call    delaywms
064D   223B           02592         call    LCDscroll       ;initialise  LCD scrolling
                      02593         
                      02594 ; Set up the hardware timers that will cause interrupts
                      02595 
                      02596 ; set timer 2 procedure
                      02597 ; set timer 2 to 0
                      02598 ; set PR2
                      02599 ; set pre-scaler
                      02600 ; set post scaler
                      02601 ; timer 2 starts at 0 , causes an interrupt bit to be set when matches PR2 which resets TMR2 to 0
                      02602 ; need to monitor the interrupt bit and clear it, also need to write to T2CON to clear the postscaler.
                      02603 
                      02604 ; Set Timer 2 to  give   6.656 mS for Creed Printer Bitbang and enable its interrupt
                      02605                                                                                                
064E   300A           02606         movlw   b'00001010'     ; Pre and postscaler as above, Timer2 off
064F   0092           02607         movwf   T2CON
                      02608         Bank1
0650   1683               M         bsf STATUS, RP0
0651   1303               M         bcf STATUS, RP1
0652   30D0           02609         movlw   .208    ; Compare with 208
0653   0092           02610         movwf   PR2
                      02611         Bank0
0654   1283               M         bcf STATUS, RP0
0655   1303               M         bcf STATUS, RP1
0656   3000           02612         movlw   0       
0657   0091           02613         movwf   TMR2    ; reset timer 2 count
                      02614 
                      02615 
                      02616 ;Set Timer 1 depending on baud rate selected from menu and store values so that the count can be reset i
                            n the interrupt routine.
                      02617 
0658   0835           02618         movfw   baud_rate
0659   3C2D           02619         sublw   .45
065A   1903 2E65      02620         bz      Tmr1_45
065C   0835           02621         movfw   baud_rate
065D   3C32           02622         sublw   .50
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 59


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

065E   1903 2E6E      02623         bz      Tmr1_50
0660   0835           02624         movfw   baud_rate
0661   3C4B           02625         sublw   .75
0662   1903 2E77      02626         bz      Tmr1_75
0664   2E80           02627         goto    Tmr1_100
                      02628 
                      02629 
                      02630 ; set timer 1 to give 7.334 mS ticks for Terminal unit at 45.45 baud
                      02631 ;T1CON.4 =  0                                                                   
                      02632 ;T1CON.5 =  0                                                                   
                      02633 ;TMR1 =  58201  
                      02634 
0665   3000           02635 Tmr1_45 movlw   b'00000000'     ; Pre-scaler as above, sleep osc off, internal osc  Timer1 off
0666   0090           02636         movwf   T1CON
0667   30E3           02637         movlw   .58201/.256
0668   00BF           02638         movwf   timer1_h
0669   008F           02639         movwf   TMR1H
066A   3059           02640         movlw   .58201  & .255
066B   00C0           02641         movwf   timer1_l        
066C   008E           02642         movwf   TMR1L
066D   2E89           02643         goto    Tmr0
                      02644 
                      02645 
                      02646 ; set timer 1 to give 6.6660 mS ticks for Terminal unit at 50 baud
                      02647 ; T1CON.4 =  0                                                                   
                      02648 ; T1CON.5 =  0                                                                   
                      02649 ; TMR1 =  58869     
                      02650 
066E   3000           02651 Tmr1_50 movlw   b'00000000'     ; Pre-scaler as above, sleep osc off, internal osc  Timer1 off
066F   0090           02652         movwf   T1CON
0670   30E5           02653         movlw   .58869/.256
0671   00BF           02654         movwf   timer1_h
0672   008F           02655         movwf   TMR1H
0673   30F5           02656         movlw   .58869  & .255
0674   00C0           02657         movwf   timer1_l        
0675   008E           02658         movwf   TMR1L
0676   2E89           02659         goto    Tmr0
                      02660 
                      02661 
                      02662 ; set timer 1 to give 4.4440 mS ticks for Terminal unit at 75 baud
                      02663 ; T1CON.4 =  0                                                                   
                      02664 ; T1CON.5 =  0                                                                   
                      02665 ; TMR1 =  61091
                      02666         
0677   3000           02667 Tmr1_75 movlw   b'00000000'     ; Pre-scaler as above, sleep osc off, internal osc  Timer1 off
0678   0090           02668         movwf   T1CON
0679   30EE           02669         movlw   .61091/.256
067A   00BF           02670         movwf   timer1_h
067B   008F           02671         movwf   TMR1H
067C   30A3           02672         movlw   .61091  & .255
067D   00C0           02673         movwf   timer1_l        
067E   008E           02674         movwf   TMR1L
067F   2E89           02675         goto    Tmr0
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 60


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      02676 
                      02677 ; set timer 1 to give 3.333mS ticks for Terminal unit at 100 baud
                      02678 ; T1CON.4 =  0                                                                   
                      02679 ; T1CON.5 =  0                                                                   
                      02680 ; TMR1 =  62202      
                      02681 
                      02682 
0680   3000           02683 Tmr1_100        movlw   b'00000000'     ; Pre-scaler as above, sleep osc off, internal osc  Timer1 off
0681   0090           02684         movwf   T1CON
0682   30F2           02685         movlw   .62202/.256
0683   00BF           02686         movwf   timer1_h
0684   008F           02687         movwf   TMR1H
0685   30FA           02688         movlw   .62202  & .255
0686   00C0           02689         movwf   timer1_l        
0687   008E           02690         movwf   TMR1L
0688   2E89           02691         goto    Tmr0
                      02692 
                      02693 ; Set Timer 0 to  give 25mS tick, interrupt status bit will be polled in the base loop
0689                  02694 Tmr0
                      02695         Bank1
0689   1683               M         bsf STATUS, RP0
068A   1303               M         bcf STATUS, RP1
068B   0064           02696         clrwdt
068C   1181           02697         bcf     OPTION_REG,PSA  ; set pre-scaler to Timer 0 (not WDT)
068D   1001           02698         bcf     OPTION_REG,PS0  ;and Timer 0 prescale to 128:1
068E   1481           02699         bsf     OPTION_REG,PS1 
068F   1501           02700         bsf     OPTION_REG,PS2
0690   1281           02701         bcf     OPTION_REG,T0CS ;and operate as a timer not counter.
                      02702         Bank0
0691   1283               M         bcf STATUS, RP0
0692   1303               M         bcf STATUS, RP1
0693   303E           02703         movlw   .62             ; set timer0 counter. 62
0694   0081           02704         movwf   TMR0
0695   110B           02705         bcf     INTCON,T0IF     ; clear the interrupt flag
0696   128B           02706         bcf     INTCON,T0IE     ; and disable the interrupt.
                      02707 
                      02708 ; interrupt indicated by INTCON.T0IF clear the bit before enabling the interrupt.
                      02709 ; interrupt routine (not used) must reset the timer and renable INTCON.T0IE
                      02710 
                      02711 
                      02712 ; enable interrupts for Timer 2  and Timer1 and start timer
0697   100C           02713         BCF             PIR1, TMR1IF    ; Reset flag that indicates interrupt
0698   108C           02714         BCF             PIR1, TMR2IF    ; Reset flag that indicates interrupt
                      02715         Bank1
0699   1683               M         bsf STATUS, RP0
069A   1303               M         bcf STATUS, RP1
069B   140C           02716                 BSF             PIE1, TMR1IE    ; Enable Timer 1 to interrupt
069C   148C           02717         BSF             PIE1, TMR2IE    ; Enable Timer 2 to interrupt
                      02718         Bank0   
069D   1283               M         bcf STATUS, RP0
069E   1303               M         bcf STATUS, RP1
069F   170B           02719         BSF             INTCON, PEIE    ; Enable Peripheral Interrupts
06A0   178B           02720                 BSF     INTCON, GIE     ; Enable interrupts
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 61


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

06A1   1410           02721         BSF     T1CON, TMR1ON   ; Enable Timer 1
06A2   1512           02722         bsf     T2CON, TMR2ON   ; Timer2 starts to increment
                      02723 
06A3   26AE           02724         call    ZBaseloop               ; and start the Base Loop
06A4   2EA4           02725 help    goto    help            ; should never get here
                      02726 
                      02727 ; Initialise application tasks
06A5                  02728 ZInit
06A5   247E           02729         call    ZInitio ; Discrete I/O
06A6   261F           02730         call    ZTimersinit     ;Timers
06A7   2282           02731         call    ZUSARTinit      ;USART
06A8   21FD           02732         call    ZLCDinit        ;LCD Display
06A9   2005           02733         call    ZMenuinit       ;Menu
06AA   22E7           02734         call    ZCreedinit      ; Initialize Creed I/O
06AB   238C           02735         call    ZTUinit ;Terminal Unit
06AC   24C5           02736         call    ZModesinit      
                      02737 
                      02738 ;PUT MORE INITIALISATION HERE
06AD   0008           02739         return
                      02740 
                      02741 
06AE                  02742 ZBaseloop
06AE   22C8           02743         call    USARTrx         ;Read character from USART hardware
                      02744                                 ;creed and TU respond to interupt routines so no need to poll
06AF   200D           02745         call    ZMenu           ;menu button pressed?
                      02746 
06B0   24C6           02747         call    ZModes          ;do transfer according to current mode
                      02748         ; send  any asynchronuos data generated to hardware     
06B1   2313           02749         call    Creedbuftotx            ;transfer data from Creed Printer 16 buffer to single buffer
06B2   22B6           02750         call    USARTbuftotx    ;transfer data from USART Tx 16 buffer to single buffer
06B3   23E4           02751         call    TUbuftotx               ;transfer data from Creed Printer 16 buffer to single buffer
06B4   22DD           02752         call    USARTtx         ;transmit a character to USART
                      02753 
                      02754 ;;; PUT MORE BASE LOOP TASKS HERE
                      02755 
                      02756         
06B5   26B7           02757         call    ZTick   ; test for the regular tick
06B6   2EAE           02758         goto    ZBaseloop
                      02759 ;}
                      02760 ;TICK
                      02761 ;{
                      02762 
06B7                  02763 ZTick   
                      02764         Bank0
06B7   1283               M         bcf STATUS, RP0
06B8   1303               M         bcf STATUS, RP1
06B9   1D0B           02765         BTFSS   INTCON,T0IF     ;is it time for the tick
06BA   0008           02766         return
                      02767 ;
                      02768 ; Timer 0 has overflowed - clear overflow flag, and reset timer
                      02769 
06BB   303E           02770         movlw   .62             ; set timer0 counter.
06BC   0081           02771         movwf   TMR0
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 62


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

06BD   110B           02772         bcf     INTCON,T0IF     ; clear the interrupt flag
                      02773         
                      02774 ;;; PUT MORE TICK TASKS HERE
06BE   24A2           02775         call    ZReadinputs     ; read the discrete inputs
06BF   239F           02776         call    TUlock          ; condition the TU lock 
06C0   24C4           02777         call    ZSendoutputs    ; send the discrete regular outputs
06C1   2624           02778         call    ZTimers         ; increment the timer counters
                      02779 
06C2   0064           02780         clrwdt                  ; will not work because tick is longer the 18mS.
06C3   0008           02781         return
                      02782         
                      02783 ;}
                      02784 
                      02785 ;INTERRUPT ROUTINE
                      02786 
                      02787 ;{
06C4                  02788 ZIntroutine        
06C4   00FB           02789                 MOVWF   int_w           ; Copy W to a temporary register
06C5   0E03           02790                 SWAPF   STATUS,W        ; Swap Status Nibbles and move to W 
06C6   00FC           02791                 MOVWF   int_status      ; Copy STATUS to a temporary register
                      02792                 
                      02793         Bank0
06C7   1283               M         bcf STATUS, RP0
06C8   1303               M         bcf STATUS, RP1
06C9   080A           02794         movfw   PCLATH  ; savePCLATH
06CA   00FD           02795                 movwf   int_pclath 
                      02796                         
06CB   080C           02797         movfw   PIR1    ;save interupt registers so we can clear them without funny effectds
06CC   00FE           02798         movwf   int_pir1
06CD   080D           02799         movfw   PIR2
06CE   00FF           02800         movwf   int_pir2
                      02801         
                      02802           
                      02803 
                      02804 ; Try timer 2 - Creed bitbang
06CF                  02805 Inttimer2
06CF   1C8C           02806         BTFSS   PIR1, TMR2IF    ; Has TMR2 interrupt occurred?
06D0   2ED4           02807         GOTO    Inttimer1               ; No    
06D1   108C           02808         BCF     PIR1, TMR2IF    ; Yes, clear flag       
06D2   235B           02809         call    CRBBRxisr               ;and do bitbang for creed
06D3   2327           02810         call    CRBBTxisr
                      02811 
06D4                  02812 Inttimer1
06D4   1C0C           02813         BTFSS   PIR1, TMR1IF    ; Has TMR1 interrupt occurred?
06D5   2EDF           02814         GOTO    Intexit         ; No    
06D6   100C           02815         BCF     PIR1, TMR1IF    ; Yes, clear flag
06D7   1010           02816         bcf     T1CON,0 ; Turn the timer off.
06D8   083F           02817         movfw   timer1_h                ;set it from the stroed values
06D9   008F           02818         movwf   TMR1H
06DA   0840           02819         movfw   timer1_l        
06DB   008E           02820         movwf   TMR1L
06DC   1410           02821         bsf     T1CON,0 ; Turn the timer on.
                      02822 
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 63


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      02823         
06DD   2442           02824         call    TUBBRxisr               ; and do bit bang for Terminal unit
06DE   23F8           02825         call    TUBBTxisr
                      02826 
06DF                  02827 Intexit                      
                      02828 ; Exit the interrupt service routine. 
                      02829 ; This involves recovering W and STATUS and then
                      02830 ; returning. Note that putting STATUS back automatically pops the bank
                      02831 ; back as well.
                      02832         Bank0
06DF   1283               M         bcf STATUS, RP0
06E0   1303               M         bcf STATUS, RP1
06E1   087D           02833                 movfw   int_pclath
06E2   008A           02834         movwf   PCLATH  ; restore PCLATH
                      02835       
06E3   0E7C           02836                 SWAPF   int_status,W    ; Pull Status back into W
06E4   0083           02837                 MOVWF   STATUS          ; Store it in status 
06E5   0EFB           02838                 SWAPF   int_w,F         ; Prepare W to be restored
06E6   0E7B           02839                 SWAPF   int_w,W         ; Return it, preserving Z bit in STATUS
06E7   0009           02840                 RETFIE
                      02841                 
                      02842 ;}
                      02843 
                      02844 ;DATA
                      02845 ;{
                      02846 ; Page 0 ends at 7FFH
0800                  02847         org     800H
                      02848 
                      02849 
                      02850 
                      02851 ;MENU DATA                       
0800   0031 002E 0030 02852 versionstr      data    '1','.','0',0
       0000 
0804   0049 0074 0065 02853 setstr  data    'I','t','e','m',' ','S','e','t',' ','R','e','s','t','a','r','t',0
       006D 0020 0053 
       0065 0074 0020 
       0052 0065 0073 
       0074 0061 0072 
       0074 0000 
0815   004D 0030 0047 02854 welstr  data    'M','0','G','B','P',' ','R','T','T','Y',0
       0042 0050 0020 
       0052 0054 0054 
       0059 0000 
                      02855 
                      02856 ; menus consist of the string for each entry followed by the value associated with the string
                      02857 ; list of menu items is terminated by a null string
                      02858 ; topmenu values are addresses of the second level menu table
0820   004D 006F 0064 02859 topmenu data    'M','o','d','e','>',0,modemenu
       0065 003E 0000 
       085F 
0827   0042 0061 0075 02860         data    'B','a','u','d','>',0,baudmenu
       0064 003E 0000 
       08B3 
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 64


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

082E   0052 0065 0076 02861         data    'R','e','v','e','r','s','e','>',0,reversemenu
       0065 0072 0073 
       0065 003E 0000 
       08D0 
0838   0041 0075 0074 02862         data    'A','u','t','o','L','F','>',0,autolfmenu
       006F 004C 0046 
       003E 0000 08E1 
0841   0044 0069 0064 02863         data    'D','i','d','d','l','e','s','>',0,diddlesmenu
       0064 006C 0065 
       0073 003E 0000 
       08F2 
084B   0041 0075 0074 02864         data    'A','u','t','o','s','t','a','r','t','>',0,autostartmenu
       006F 0073 0074 
       0061 0072 0074 
       003E 0000 0903 
0857   0055 0053 004F 02865         data    'U','S','O','S','>',0,USOSmenu
       0053 003E 0000 
       0914 
085E   0000           02866         data    0
                      02867 
                      02868 ; second level menu values are the data to be saved.
                      02869 ; The last entry of second level menus should be the menu entry 'Exit' which has the value 100h
                      02870 ;  second level menus must appear in the order in which the result is stored in EEPROM
085F   0057 0065 0061 02871 modemenu        data    'W','e','a','t','h','e','r',0,0
       0074 0068 0065 
       0072 0000 0000 
0868   0054 0055 0020 02872         data    'T','U',' ','t','o',' ','C','r','e','e','d',0,1
       0074 006F 0020 
       0043 0072 0065 
       0065 0064 0000 
       0001 
0875   0054 0055 0020 02873         data    'T','U',' ','t','o',' ','P','C',0,2
       0074 006F 0020 
       0050 0043 0000 
       0002 
087F   0050 0043 0020 02874         data    'P','C',' ','t','o',' ','C','r','e','e','d',0,3
       0074 006F 0020 
       0043 0072 0065 
       0065 0064 0000 
       0003 
088C   0043 0072 0065 02875         data    'C','r','e','e','d',' ','L','o','o','p',0,4
       0065 0064 0020 
       004C 006F 006F 
       0070 0000 0004 
0898   0054 0055 0020 02876         data    'T','U',' ','L','o','o','p',0,5
       004C 006F 006F 
       0070 0000 0005 
08A1   0050 0043 0020 02877         data    'P','C',' ','L','o','o','p',0,6
       004C 006F 006F 
       0070 0000 0006 
08AA   0043 0061 006E 02878         data    'C','a','n','c','e','l',0,h'100'
       0063 0065 006C 
       0000 0100 
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 65


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

08B2   0000           02879         data    0
                      02880 
08B3   0034 0035 002E 02881 baudmenu        data    '4','5','.','4','5',0,.45
       0034 0035 0000 
       002D 
08BA   0035 0030 0000 02882         data    '5','0',0,.50
       0032 
08BE   0037 0035 0000 02883         data    '7','5',0,.75
       004B 
08C2   0031 0030 0030 02884         data    '1','0','0',0,.100      
       0000 0064 
08C7   0043 0061 006E 02885         data    'C','a','n','c','e','l',0,h'100'
       0063 0065 006C 
       0000 0100 
08CF   0000           02886         data    0
                      02887 
08D0                  02888 reversemenu
08D0   004F 006E 0000 02889         data    'O','n',0,h'FF'
       00FF 
08D4   004F 0066 0066 02890         data    'O','f','f',0,h'0'
       0000 0000 
08D9   0043 0061 006E 02891         data    'C','a','n','c','e','l',0,h'100'        
       0063 0065 006C 
       0000 0100 
                      02892         
08E1                  02893 autolfmenu
08E1   004F 006E 0000 02894         data    'O','n',0,h'FF'
       00FF 
08E5   004F 0066 0066 02895         data    'O','f','f',0,h'0'
       0000 0000 
08EA   0043 0061 006E 02896         data    'C','a','n','c','e','l',0,h'100'
       0063 0065 006C 
       0000 0100 
                      02897         
08F2                  02898 diddlesmenu
08F2   004F 006E 0000 02899         data    'O','n',0,h'FF'
       00FF 
08F6   004F 0066 0066 02900         data    'O','f','f',0,h'0'
       0000 0000 
08FB   0043 0061 006E 02901         data    'C','a','n','c','e','l',0,h'100'
       0063 0065 006C 
       0000 0100 
                      02902         
0903                  02903 autostartmenu
0903   004F 006E 0000 02904         data    'O','n',0,h'FF'
       00FF 
0907   004F 0066 0066 02905         data    'O','f','f',0,h'0'
       0000 0000 
090C   0043 0061 006E 02906         data    'C','a','n','c','e','l',0,h'100'
       0063 0065 006C 
       0000 0100 
                      02907         
0914                  02908 USOSmenu
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 66


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0914   004F 006E 0000 02909         data    'O','n',0,h'FF'
       00FF 
0918   004F 0066 0066 02910         data    'O','f','f',0,h'0'
       0000 0000 
091D   0043 0061 006E 02911         data    'C','a','n','c','e','l',0,h'100'
       0063 0065 006C 
       0000 0100 
                      02912 
                      02913                 
                      02914 ; ITA2/ASCII CONVERSION
                      02915         
                      02916 ; ASCII - all values here
                      02917 ; Shift  - F, L, B, and U if character does not have a ITA2 equivalent ITA2 value
                      02918 ; when the shift is 'U' the ITA value is meaningless.
                      02919 ; The conversion is based on ITA2 with the characters =, %, and @ being special for Creed444. 
                      02920 
0925                  02921 codeconvert
0925   0000 0042 0000 02922   data 0x0, 'B', 0      ;NULL
0928   0001 0055 0000 02923   data 0x1, 'U', 0      ;soh
092B   0002 0055 0000 02924   data 0x2, 'U', 0       ; stx 
092E   0003 0055 0000 02925   data 0x3, 'U', 0      ; etx 
0931   0004 0055 0000 02926   data 0x4, 'U', 0       ; eot 
0934   0005 0055 0000 02927   data 0x5, 'U', 0      ; enq 
0937   0006 0055 0000 02928   data 0x6, 'U', 0      ; ack 
093A   0007 0055 0000 02929   data 0x7, 'U',.0      ; bell bel is converted to ^
093D   0008 0055 0000 02930   data 0x8, 'U',0       ; bs 
0940   0009 0055 0000 02931   data 0x9, 'U',0        ; tab
0943   000A 0042 0002 02932   data 0xa, 'B', .2     ; LF 
0946   000B 0055 0000 02933   data 0xb, 'U',0       ; vt 
0949   000C 0055 0000 02934   data 0xc, 'U',0       ; ff 
094C   000D 0042 0008 02935   data 0xd, 'B', .8     ; CR 
094F   000E 0055 0000 02936   data 0xe, 'U',0       ; so 
0952   000F 0055 0000 02937   data 0xf, 'U',0       ; si 
0955   0010 0055 0000 02938   data 0x10, 'U',0       ; dle 
0958   0011 0055 0000 02939   data 0x11, 'U',0       ; dc1 
095B   0012 0055 0000 02940   data 0x12, 'U',0       ; dc2 
095E   0013 0055 0000 02941   data 0x13, 'U',0      ; dc3 
0961   0014 0055 0000 02942   data 0x14, 'U',0      ; dc4 
0964   0015 0055 0000 02943   data 0x15, 'U',0       ; nak 
0967   0016 0055 0000 02944   data 0x16, 'U',0      ; syn 
096A   0017 0055 0000 02945   data 0x17, 'U',0      ; etb 
096D   0018 0055 0000 02946   data 0x18, 'U',0       ; can
0970   0019 0055 0000 02947   data 0x19, 'U',0       ; em 
0973   001A 0055 0000 02948   data 0x1a, 'U',0      ; sub 
0976   001B 0042 001B 02949   data 0x1b, 'B',.27    ;  esc - ITA2 'FIGS'
0979   001C 0055 0000 02950   data 0x1c, 'U',0       ; fs 
097C   001D 0055 0000 02951   data 0x1d, 'U',0       ; gs 
097F   001E 0055 0000 02952   data 0x1e, 'U',0      ; rs 
0982   001F 0042 001F 02953   data 0x1f, 'B',.31      ; us  - ITA 2LTRS 
0985   0020 004C 0004 02954   data 0x20, 'L',.4      ; SPACE  - ITA2 has this as both but made L so space is always transmitted in l
                            etters shift for USOS
                      02955                 ; ita2 to ASCII character conversion routine makes allowance for this.
0988   0021 0055 0000 02956   data 0x21,   'U', 0     ; ! (exclamation) 
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 67


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

098B   0022 0055 0000 02957   data 0x22,   'U', 0     ; " 
098E   0023 0046 0009 02958   data 0x23,   'F', 9     ; # 
0991   0024 0046 0014 02959   data 0x24,   'F', .20   ; $ (dollar) - ITA2 
0994   0025 0046 000D 02960   data 0x25, 'F',.13     ;%  (percent)
0997   0026 0055 0000 02961   data 0x26,  'U', 0      ;&  
099A   0027 0046 0005 02962   data 0x27,   'F', .5    ;'  (sgl quote) 
099D   0028 0046 000F 02963   data 0x28,   'F', .15   ; ( 
09A0   0029 0046 0012 02964   data 0x29,   'F', .18   ; ) 
09A3   002A 0055 0000 02965   data 0x2a,  'U',0      ;* (asterisk) 
09A6   002B 0046 0011 02966   data 0x2b,  'F',.17   ; + (plus) 
09A9   002C 0046 000C 02967   data 0x2c,   'F', .12   ; , 
09AC   002D 0046 0003 02968   data 0x2d,   'F', .3    ; - 
09AF   002E 0046 001C 02969   data 0x2e,   'F', .28   ; . 
09B2   002F 0046 001D 02970   data 0x2f,   'F', .29    ; / 
09B5   0030 0046 0016 02971   data 0x30,   'F', .22   ; 0 
09B8   0031 0046 0017 02972   data 0x31,   'F', .23   ; 1 
09BB   0032 0046 0013 02973   data 0x32,   'F', .19   ; 2 
09BE   0033 0046 0001 02974   data 0x33,   'F', .1    ; 3 
09C1   0034 0046 000A 02975   data 0x34,   'F', .10   ; 4 
09C4   0035 0046 0010 02976   data 0x35,   'F', .16   ; 5 
09C7   0036 0046 0015 02977   data 0x36,   'F', .21   ; 6 
09CA   0037 0046 0007 02978   data 0x37,   'F', .7    ; 7 
09CD   0038 0046 0006 02979   data 0x38,   'F', .6    ; 8 
09D0   0039 0046 0018 02980   data 0x39,   'F', .24   ; 9 
09D3   003A 0046 000E 02981   data 0x3a,   'F', .14   ; : 
09D6   003B 0055 0000 02982   data 0x3b,   'U', 0     ; ; 
09D9   003C 0055 0000 02983   data 0x3c, 'U',0       ;<  (LT) 
09DC   003D 0046 001E 02984   data 0x3d,  'F',.30    ;= (equal) 
09DF   003E 0055 0000 02985   data 0x3e,   'U',0     ; > (GT) 
09E2   003F 0046 0019 02986   data 0x3f,     'F', .25         ; ? 
09E5   0040 0046 001A 02987  data 0x40,   'F',.26    ; @ (at) 
09E8   0041 004C 0003 02988  data 0x41,     'L', .3   ; A 
09EB   0042 004C 0019 02989  data 0x42,     'L', .25          ; B 
09EE   0043 004C 000E 02990  data 0x43,     'L', .14          ; C 
09F1   0044 004C 0009 02991  data 0x44,     'L', .9   ; D 
09F4   0045 004C 0001 02992  data 0x45,     'L', .1   ; E 
09F7   0046 004C 000D 02993  data 0x46,     'L', .13          ; F 
09FA   0047 004C 001A 02994  data 0x47,     'L', .26          ; G 
09FD   0048 004C 0014 02995  data 0x48,     'L', .20          ; H 
0A00   0049 004C 0006 02996  data 0x49,     'L', .6   ; I 
0A03   004A 004C 000B 02997  data 0x4a,     'L', .11          ; J 
0A06   004B 004C 000F 02998  data 0x4b,     'L', .15          ; K 
0A09   004C 004C 0012 02999  data 0x4c,     'L', .18          ; L 
0A0C   004D 004C 001C 03000  data 0x4d,     'L', .28          ; M 
0A0F   004E 004C 000C 03001  data 0x4e,     'L', .12          ; N 
0A12   004F 004C 0018 03002  data 0x4f,     'L', .24          ; O 
0A15   0050 004C 0016 03003  data 0x50,     'L', .22          ; P 
0A18   0051 004C 0017 03004  data 0x51,     'L', .23          ; Q 
0A1B   0052 004C 000A 03005  data 0x52,     'L', .10          ; R 
0A1E   0053 004C 0005 03006  data 0x53,     'L', .5   ; S 
0A21   0054 004C 0010 03007  data 0x54,     'L', .16          ; T 
0A24   0055 004C 0007 03008  data 0x55,     'L', .7   ; U 
0A27   0056 004C 001E 03009  data 0x56,     'L', .30          ; V 
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 68


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0A2A   0057 004C 0013 03010  data 0x57,     'L', .19          ; W 
0A2D   0058 004C 001D 03011  data 0x58,     'L', .29          ; X 
0A30   0059 004C 0015 03012  data 0x59,     'L', .21          ; Y 
0A33   005A 004C 0011 03013  data 0x5a,     'L', .17          ; Z 
0A36   005B 0055 0000 03014  data 0x5b,   'U',0      ; [ (L bkt) 
0A39   005C 0055 0000 03015  data 0x5c,   'U',0      ; \ (back sl) 
0A3C   005D 0055 0000 03016  data 0x5d,   'U',0      ; ] (R bkt) 
0A3F   005E 0046 000B 03017  data 0x5e,   'F',.11    ; ^ (caret) 
0A42   005F 0055 0000 03018  data 0x5f,   'U',0      ; _ (underscore)
0A45   0060 0055 0000 03019  data 0x60,   'U',0     ; ~ tilde
                      03020 ;; lowercase alphabet converted to uppercase
0A48   0061 004C 0003 03021  data 0x61,     'L', .3   ; A 
0A4B   0062 004C 0019 03022  data 0x62,     'L', .25          ; B 
0A4E   0063 004C 000E 03023  data 0x63,     'L', .14          ; C 
0A51   0064 004C 0009 03024  data 0x64,     'L', .9   ; D 
0A54   0065 004C 0001 03025  data 0x65,     'L', .1   ; E 
0A57   0066 004C 000D 03026  data 0x66,     'L', .13          ; F 
0A5A   0067 004C 001A 03027  data 0x67,     'L', .26          ; G 
0A5D   0068 004C 0014 03028  data 0x68,     'L', .20          ; H 
0A60   0069 004C 0006 03029  data 0x69,     'L', .6   ; I 
0A63   006A 004C 000B 03030  data 0x6a,     'L', .11          ; J 
0A66   006B 004C 000F 03031  data 0x6b,     'L', .15          ; K 
0A69   006C 004C 0012 03032  data 0x6c,     'L', .18          ; L 
0A6C   006D 004C 001C 03033  data 0x6d,     'L', .28          ; M 
0A6F   006E 004C 000C 03034  data 0x6e,     'L', .12          ; N
0A72   006F 004C 0018 03035  data 0x6f,      'L', .24         ; O
0A75   0070 004C 0016 03036  data 0x70,     'L', .22          ; P 
0A78   0071 004C 0017 03037  data 0x71,     'L', .23          ; Q 
0A7B   0072 004C 000A 03038  data 0x72,     'L', .10          ; R 
0A7E   0073 004C 0005 03039  data 0x73,     'L', .5   ; S 
0A81   0074 004C 0010 03040  data 0x74,     'L', .16          ; T 
0A84   0075 004C 0007 03041  data 0x75,     'L', .7   ; U 
0A87   0076 004C 001E 03042  data 0x76,     'L', .30          ; V 
0A8A   0077 004C 0013 03043  data 0x77,     'L', .19          ; W 
0A8D   0078 004C 001D 03044  data 0x78,     'L', .29          ; X 
0A90   0079 004C 0015 03045  data 0x79,     'L', .21          ; Y 
0A93   007A 004C 0011 03046  data 0x7a,     'L', .17          ; Z 
0A96   007B 0055 0000 03047  data 0x7b,   'U',0     ;open curly
0A99   007C 0055 0000 03048  data 0x7c,   'U',0     ;|
0A9C   007D 0055 0000 03049  data 0x7d,   'U',0     ;close curly
0A9F   007E 0055 0000 03050  data 0x7e,   'U',0     ;~
0AA2   007F 0055 0000 03051  data 0x7f,   'U',0     ;DEL
                      03052 
                      03053 
                      03054 ;error strings
0AA5   0045 0072 0072 03055 errcpbuf        data    'E','r','r',':','C','r','e','e','d',' ','P','r','i','n','t',0
       003A 0043 0072 
       0065 0065 0064 
       0020 0050 0072 
       0069 006E 0074 
       0000 
0AB5   0045 0072 0072 03056 errTUbuf        data    'E','r','r',':','T','U',' ','M','o','d','u','l','a','t','e',0
       003A 0054 0055 
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 69


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

       0020 004D 006F 
       0064 0075 006C 
       0061 0074 0065 
       0000 
0AC5   0045 0072 0072 03057 errurbuf        data    'E','r','r',':','P','C',' ','R','x',0
       003A 0050 0043 
       0020 0052 0078 
       0000 
0ACF   0045 0072 0072 03058 errutbuf        data    'E','r','r',':','P','C',' ','T','x',0
       003A 0050 0043 
       0020 0054 0078 
       0000 
0AD9   0045 0072 0072 03059 errmode data    'E','r','r',':','M','o','d','e',0
       003A 004D 006F 
       0064 0065 0000 
                      03060 
                      03061 ;}
                      03062 
                      03063 ;Initiliase EEPROM for when the program is first downloaded
2100                  03064  org    h'2100' 
2100   0000           03065   de    .0      ; mode = 0  weather
2101   0032           03066   de    .50     ; baud rate for TU  is 50
2102   0000           03067   de    .0      ;reverse off
2103   00FF           03068   de    h'FF'   ; autoLF 0n
2104   0000           03069   de    .0      ;diddles off
2105   0000           03070   de    .0      ;autostart off
2106   0000           03071   de    .0      ; USOS off
                      03072         end
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 70


SYMBOL TABLE
  LABEL                             VALUE 

ACKDT                             00000005
ACKEN                             00000004
ACKSTAT                           00000006
ADCON0                            0000001F
ADCON1                            0000009F
ADCS0                             00000006
ADCS1                             00000007
ADDEN                             00000003
ADFM                              00000007
ADIE                              00000006
ADIF                              00000006
ADON                              00000000
ADRESH                            0000001E
ADRESL                            0000009E
BCLIE                             00000003
BCLIF                             00000003
BF                                00000000
BRGH                              00000002
Bank0                             
Bank1                             
Bank2                             
Bank3                             
C                                 00000000
CCP1CON                           00000017
CCP1IE                            00000002
CCP1IF                            00000002
CCP1M0                            00000000
CCP1M1                            00000001
CCP1M2                            00000002
CCP1M3                            00000003
CCP1X                             00000005
CCP1Y                             00000004
CCP2CON                           0000001D
CCP2IE                            00000000
CCP2IF                            00000000
CCP2M0                            00000000
CCP2M1                            00000001
CCP2M2                            00000002
CCP2M3                            00000003
CCP2X                             00000005
CCP2Y                             00000004
CCPR1                             00000015
CCPR1H                            00000016
CCPR1L                            00000015
CCPR2                             0000001B
CCPR2H                            0000001C
CCPR2L                            0000001B
CHS0                              00000003
CHS1                              00000004
CHS2                              00000005
CKE                               00000006
CKP                               00000004
CRBBRxisr                         0000035B
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 71


SYMBOL TABLE
  LABEL                             VALUE 

CRBBRxtab                         00000362
CRBBTxisr                         00000327
CRBBTxtab                         0000032E
CREN                              00000004
CRRXWORK                          0000004E
CRRX_BIT                          0000037A
CRRX_BUF                          0000037F
CRRX_CHK                          00000377
CRRX_NXT                          0000038A
CRRX_RES                          00000386
CRRX_SM                           00000050
CRTXWORK                          0000004D
CRTX_0                            00000355
CRTX_1                            00000353
CRTX_BIT                          00000351
CRTX_BUF                          00000350
CRTX_CHK                          00000343
CRTX_CHK1                         0000034B
CRTX_NXT                          00000357
CRTX_RES                          00000359
CRTX_SM                           0000004F
CRTX_STOP                         0000034E
CRTX_STRT                         0000034C
CSRC                              00000007
Ccaddoffset                       000001AD
Ccatoi                            00000129
Ccgotoentry                       00000194
Ccitoa                            00000136
Ccitoa1                           0000016C
Ccitoa2                           0000013B
Ccitoa4                           00000158
Ccitoa5                           00000166
Ccitoa6                           00000169
Conditioninokend                  00000016
Conditionnextend                  00000021
Creedbuftotx                      00000313
Creedbuftotxend                   00000325
Creedchar                         000002F8
Creedcharerror                    00000308
Creedcharerror1                   00000312
D                                 00000005
DATA_ADDRESS                      00000005
DC                                00000001
D_A                               00000005
D_NOT_A                           00000005
Decodeporta1                      000004B5
Decodeporta2                      000004B6
Decodeporta3                      000004BB
Decodeporta4                      000004BC
Decodeporta5                      000004C1
Decodeporta6                      000004C2
DoMark                            
DoSpace                           
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 72


SYMBOL TABLE
  LABEL                             VALUE 

DoTUMark                          
DoTUSpace                         
Domotoroff                        
Domotoron                         
EEADR                             0000010D
EEADRH                            0000010F
EECON1                            0000018C
EECON2                            0000018D
EEDATA                            0000010C
EEDATH                            0000010E
EEIE                              00000004
EEIF                              00000004
EEIsBusy                          00000124
EEPCcrlf                          3
EEPGD                             00000007
EETUbaud                          1
EETUreverse                       2
EEUSOS                            6
EEautostart                       5
EEdiddles                         4
EEmode                            0
F                                 00000001
FERR                              00000002
FSR                               00000004
GCEN                              00000007
GIE                               00000007
GO                                00000002
GO_DONE                           00000002
GO_NOT_DONE                       00000002
I2C_DATA                          00000005
I2C_READ                          00000002
I2C_START                         00000003
I2C_STOP                          00000004
INDF                              00000000
INTCON                            0000000B
INTE                              00000004
INTEDG                            00000006
INTF                              00000001
IRP                               00000007
ITA2char                          00000070
Inctblptr                         000001D5
Interrupt                         00000001
Intexit                           000006DF
Inttimer1                         000006D4
Inttimer2                         000006CF
LCD_E                             PORTC, 4
LCD_RS                            PORTC, 5
LCDaddress                        0000022E
LCDbyte                           0000005C
LCDchar                           00000268
LCDchar1                          00000271
LCDclear                          0000024A
LCDcom                            00000254
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 73


SYMBOL TABLE
  LABEL                             VALUE 

LCDcount1                         00000122
LCDcount2                         00000121
LCDcount3                         00000120
LCDhome                           0000024F
LCDoff                            00000234
LCDon                             00000231
LCDpos                            0000005B
LCDscroll                         0000023B
LCDshift                          00000242
LCDshift1                         00000249
LCDstatic                         00000237
LCDstr                            00000225
LCDstr1                           0000022D
LCDstrappend                      00000226
ModePCloop                        000005C4
ModePCloop1                       000005D4
ModePCloopend                     000005D8
ModePCtoCreed                     000005D9
ModePCtoCreedrx                   000005F2
ModePCtoCreedrx1                  00000610
ModePCtoCreedrx2                  0000060E
ModePCtoCreedrx3                  0000060F
ModePCtoCreedrx4                  00000619
ModePCtoCreedrxclr                0000061C
ModePCtoCreedrxend                0000061E
ModePCtoCreedtx                   000005DC
ModePCtoCreedtx1                  000005ED
ModePCtoCreedtxend                000005F1
ModeTUloop                        0000055D
ModeTUtoCreed                     00000510
ModeTUtoCreedrx                   00000513
ModeTUtoCreedrx1                  0000052C
ModeTUtoCreedrx2                  0000051C
ModeTUtoCreedrx3                  0000051B
ModeTUtoCreedrx4                  00000539
ModeTUtoCreedrxend                0000053D
ModeTUtoCreedtx                   0000053E
ModeTUtoCreedtx1                  00000551
ModeTUtoCreedtxend                00000555
ModeTUtoPC                        00000556
ModeTUtoPC1                       0000055B
ModeTUtoPCrx                      00000560
ModeTUtoPCrx1                     0000057C
ModeTUtoPCrx2                     00000571
ModeTUtoPCrxend                   0000057E
ModeTUtoPCtx                      0000057F
ModeTUtoPCtx1                     0000059D
ModeTUtoPCtx2                     0000059B
ModeTUtoPCtx3                     0000059C
ModeTUtoPCtx4                     000005A6
ModeTUtoPCtxclr                   000005A9
ModeTUtoPCtxend                   000005AB
Modecreedloop                     000005AC
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 74


SYMBOL TABLE
  LABEL                             VALUE 

Modecreedloop1                    000005BF
Modecreedloopend                  000005C3
Modeweather                       000004F0
Modeweather1                      000004FE
Modeweather2                      000004F6
Modeweather3                      000004F5
Modeweather4                      0000050B
Modeweatherend                    0000050F
Mul8x8                            0000016F
NOT_A                             00000005
NOT_ADDRESS                       00000005
NOT_BO                            00000000
NOT_BOR                           00000000
NOT_DONE                          00000002
NOT_PD                            00000003
NOT_POR                           00000001
NOT_RBPU                          00000007
NOT_RC8                           00000006
NOT_T1SYNC                        00000002
NOT_TO                            00000004
NOT_TX8                           00000006
NOT_W                             00000002
NOT_WRITE                         00000002
OERR                              00000001
OPTION_REG                        00000081
P                                 00000004
PCFG0                             00000000
PCFG1                             00000001
PCFG2                             00000002
PCFG3                             00000003
PCL                               00000002
PCLATH                            0000000A
PCON                              0000008E
PCcrlf                            00000037
PEIE                              00000006
PEN                               00000002
PIE1                              0000008C
PIE2                              0000008D
PIR1                              0000000C
PIR2                              0000000D
PORTA                             00000005
PORTB                             00000006
PORTC                             00000007
PR2                               00000092
PS0                               00000000
PS1                               00000001
PS2                               00000002
PSA                               00000003
Poweron                           000000C0
R                                 00000002
RA0                               00000000
RA1                               00000001
RA2                               00000002
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 75


SYMBOL TABLE
  LABEL                             VALUE 

RA3                               00000003
RA4                               00000004
RA5                               00000005
RB0                               00000000
RB1                               00000001
RB2                               00000002
RB3                               00000003
RB4                               00000004
RB5                               00000005
RB6                               00000006
RB7                               00000007
RBIE                              00000003
RBIF                              00000000
RC0                               00000000
RC1                               00000001
RC2                               00000002
RC3                               00000003
RC4                               00000004
RC5                               00000005
RC6                               00000006
RC7                               00000007
RC8_9                             00000006
RC9                               00000006
RCD8                              00000000
RCEN                              00000003
RCIE                              00000005
RCIF                              00000005
RCREG                             0000001A
RCSTA                             00000018
RD                                00000000
READ_WRITE                        00000002
RP0                               00000005
RP1                               00000006
RSEN                              00000001
RX9                               00000006
RX9D                              00000000
R_NOT_W                           00000002
R_W                               00000002
Readflash                         000001B6
S                                 00000003
SEN                               00000000
SMP                               00000007
SPBRG                             00000099
SPEN                              00000007
SREN                              00000005
SSPADD                            00000093
SSPBUF                            00000013
SSPCON                            00000014
SSPCON2                           00000091
SSPEN                             00000005
SSPIE                             00000003
SSPIF                             00000003
SSPM0                             00000000
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 76


SYMBOL TABLE
  LABEL                             VALUE 

SSPM1                             00000001
SSPM2                             00000002
SSPM3                             00000003
SSPOV                             00000006
SSPSTAT                           00000094
STATUS                            00000003
SYNC                              00000004
Sendoutputend                     000004C4
T0CS                              00000005
T0IE                              00000005
T0IF                              00000002
T0SE                              00000004
T1CKPS0                           00000004
T1CKPS1                           00000005
T1CON                             00000010
T1INSYNC                          00000002
T1OSCEN                           00000003
T1SYNC                            00000002
T2CKPS0                           00000000
T2CKPS1                           00000001
T2CON                             00000012
TMR0                              00000001
TMR0IE                            00000005
TMR0IF                            00000002
TMR1CS                            00000001
TMR1H                             0000000F
TMR1IE                            00000000
TMR1IF                            00000000
TMR1L                             0000000E
TMR1ON                            00000000
TMR2                              00000011
TMR2IE                            00000001
TMR2IF                            00000001
TMR2ON                            00000002
TOUTPS0                           00000003
TOUTPS1                           00000004
TOUTPS2                           00000005
TOUTPS3                           00000006
TRISA                             00000085
TRISA0                            00000000
TRISA1                            00000001
TRISA2                            00000002
TRISA3                            00000003
TRISA4                            00000004
TRISA5                            00000005
TRISB                             00000086
TRISB0                            00000000
TRISB1                            00000001
TRISB2                            00000002
TRISB3                            00000003
TRISB4                            00000004
TRISB5                            00000005
TRISB6                            00000006
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 77


SYMBOL TABLE
  LABEL                             VALUE 

TRISB7                            00000007
TRISC                             00000087
TRISC0                            00000000
TRISC1                            00000001
TRISC2                            00000002
TRISC3                            00000003
TRISC4                            00000004
TRISC5                            00000005
TRISC6                            00000006
TRISC7                            00000007
TRMT                              00000001
TUBBRxisr                         00000442
TUBBRxtab                         00000449
TUBBTxisr                         000003F8
TUBBTxtab                         000003FF
TURXWORK                          0000003C
TURX_BIT                          00000467
TURX_BUF                          0000046C
TURX_BUF1                         00000476
TURX_BUF2                         00000472
TURX_CHK                          0000045E
TURX_CHK1                         00000464
TURX_NXT                          0000047C
TURX_RES                          00000478
TURX_SM                           0000003E
TUTXWORK                          0000003B
TUTX_0                            0000043C
TUTX_1                            0000043A
TUTX_BIT                          00000438
TUTX_BUF                          00000437
TUTX_CHK                          00000414
TUTX_CHK1                         0000041C
TUTX_CHK2                         00000422
TUTX_NXT                          0000043E
TUTX_RES                          00000440
TUTX_REV                          00000423
TUTX_SM                           0000003D
TUTX_STOP                         00000430
TUTX_STOP1                        00000435
TUTX_STRT                         00000428
TUTX_STRT1                        0000042E
TUTX_STRT2                        0000042F
TUbuftotx                         000003E4
TUbuftotxend                      000003F6
TUchar                            000003C9
TUcharerror                       000003D9
TUcharerror1                      000003E3
TUlock                            0000039F
TUlock0                           000003AB
TUlock01                          000003B0
TUlock1                           000003B3
TUlock11                          000003B8
TUlock2                           000003BD
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 78


SYMBOL TABLE
  LABEL                             VALUE 

TUlock21                          000003C5
TUlock22                          000003C7
TUreverse                         00000036
TX8_9                             00000006
TX9                               00000006
TX9D                              00000000
TXD8                              00000000
TXEN                              00000005
TXIE                              00000004
TXIF                              00000004
TXREG                             00000019
TXSTA                             00000098
Timers700                         00000628
Timersend                         00000630
Tmr0                              00000689
Tmr1_100                          00000680
Tmr1_45                           00000665
Tmr1_50                           0000066E
Tmr1_75                           00000677
UA                                00000001
USARTbuftotx                      000002B6
USARTbuftotxend                   000002C7
USARTchar                         0000029C
USARTcharerror                    000002AC
USARTcharerror1                   000002B5
USARTrx                           000002C8
USARTrx1                          000002DC
USARTrxend                        000002D2
USARTrxerr                        000002D3
USARTtx                           000002DD
USARTtxend                        000002E6
USOS                              0000003A
USOSmenu                          00000914
W                                 00000000
WCOL                              00000007
WR                                00000001
WREN                              00000002
WRERR                             00000003
Z                                 00000002
ZBaseloop                         000006AE
ZCreedinit                        000002E7
ZEEread                           00000101
ZEEwrite                          0000010E
ZInit                             000006A5
ZInitio                           0000047E
ZIntroutine                       000006C4
ZLCDinit                          000001FD
ZMain                             00000631
ZMenu                             0000000D
ZMenuinit                         00000005
ZModes                            000004C6
ZModesinit                        000004C5
ZReadconfig                       0000009C
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 79


SYMBOL TABLE
  LABEL                             VALUE 

ZReadinputs                       000004A2
ZSendoutputs                      000004C4
ZTUinit                           0000038C
ZTick                             000006B7
ZTimers                           00000624
ZTimersinit                       0000061F
ZUSARTinit                        00000282
_BODEN_OFF                        00003FBF
_BODEN_ON                         00003FFF
_BOREN_OFF                        00003FBF
_BOREN_ON                         00003FFF
_CONFIG                           00002007
_CPD_OFF                          00003FFF
_CPD_ON                           00003EFF
_CP_All                           00000FCF
_CP_HALF                          00001FDF
_CP_OFF                           00003FFF
_CP_UPPER_256                     00002FEF
_DEBUG_OFF                        00003FFF
_DEBUG_ON                         000037FF
_DEVID1                           00002006
_FOSC_EXTRC                       00003FFF
_FOSC_HS                          00003FFE
_FOSC_LP                          00003FFC
_FOSC_XT                          00003FFD
_HS_OSC                           00003FFE
_IDLOC0                           00002000
_IDLOC1                           00002001
_IDLOC2                           00002002
_IDLOC3                           00002003
_LP_OSC                           00003FFC
_LVP_OFF                          00003F7F
_LVP_ON                           00003FFF
_PWRTE_OFF                        00003FFF
_PWRTE_ON                         00003FF7
_RC_OSC                           00003FFF
_WDTE_OFF                         00003FFB
_WDTE_ON                          00003FFF
_WDT_OFF                          00003FFB
_WDT_ON                           00003FFF
_WRT_ENABLE_OFF                   00003DFF
_WRT_ENABLE_ON                    00003FFF
_WRT_OFF                          00003DFF
_WRT_ON                           00003FFF
_XT_OSC                           00003FFD
__16F876                          00000001
autolfmenu                        000008E1
autostart                         00000039
autostartmenu                     00000903
baud_rate                         00000035
baudmenu                          000008B3
cc_ascii                          0
cc_ita2                           2
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 80


SYMBOL TABLE
  LABEL                             VALUE 

cc_shift                          1
cc_temp_shift                     0000006F
cctemp1                           0000006A
cctemp2                           0000006B
cctemp3                           0000006C
cctemp4                           0000006D
cctemp5                           0000006E
changed_a                         00000068
codeconvert                       00000925
codeconvert_h                     00000009
codeconvert_l                     00000025
count_A_a                         00000066
count_B_a                         00000067
cpb_read_pointer                  00000054
cpb_write_pointer                 00000053
creed_kb_data                     00000057
creed_kb_data_bit                 5
creed_kb_data_full                00000058
creed_kb_shift                    00000059
creed_motor_bit                   3
creed_printer_buffer              000000A0
creed_printer_data                00000051
creed_printer_data_bit            2
creed_printer_data_full           00000052
creed_printer_shift               0000005A
creedchar1                        00000055
creedchar2                        00000056
cur_2_menu_h                      00000030
cur_2_menu_l                      00000031
delay100us                        000001F4
delay100us1                       000001F8
delay1ms                          000001E8
delay1ms1                         000001EC
delaywms                          000001DD
delaywms1                         000001E0
demod_data_bit                    4
demod_lock_bit                    0
diddles                           00000038
diddlesmenu                       000008F2
eewriteaddress                    00000033
errTUbuf                          00000AB5
errTUbuf_h                        0000000A
errTUbuf_l                        000000B5
errcpbuf                          00000AA5
errcpbuf_h                        0000000A
errcpbuf_l                        000000A5
errmode                           00000AD9
errmode_h                         0000000A
errmode_l                         000000D9
errurbuf                          00000AC5
errurbuf_h                        0000000A
errurbuf_l                        000000C5
errutbuf                          00000ACF
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 81


SYMBOL TABLE
  LABEL                             VALUE 

errutbuf_h                        0000000A
errutbuf_l                        000000CF
false                             0x00
help                              000006A4
help1                             000004ED
inbuf_a                           00000064
inbuf_db_a                        00000065
inok_bit                          1
int_pclath                        0000007D
int_pir1                          0000007E
int_pir2                          0000007F
int_status                        0000007C
int_w                             0000007B
last_menu_inok                    0000002A
last_menu_next                    0000002D
lcd_enable_bit                    4
lcd_reg_sel_bit                   5
menu0                             00000032
menu01                            00000039
menu02                            0000003E
menu03                            00000041
menu1                             00000049
menu2                             00000050
menu21                            00000057
menu22                            00000060
menu23                            00000066
menu3                             0000006E
menu31                            00000075
menu32                            0000007D
menu4                             00000090
menu_1                            2
menu_2                            3
menu_err                          5
menu_fini                         4
menu_inok_pressed                 00000029
menu_inok_signal                  0000002B
menu_next_pressed                 0000002C
menu_next_signal                  0000002E
menu_off                          0
menu_result_index                 00000032
menu_sets                         1
menu_state                        0000002F
menu_timer                        00000061
menuend                           0000009B
menuexit                          00000094
menusigreset                      00000098
mod_data_bit                      1
mode                              00000034
modemenu                          0000085F
modes1                            00000069
modeskip                          000004EE
mult                              
next_bit                          2
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 82


SYMBOL TABLE
  LABEL                             VALUE 

resulthi                          00000123
resultlo                          00000124
reversemenu                       000008D0
sc45                              000000D1
sc50                              000000D6
sc75                              000000DB
scfl                              000000E0
setstr                            00000804
setstr_h                          00000008
setstr_l                          00000004
showconfig                        000000B2
tblptr_h                          0000005E
tblptr_l                          0000005D
tblval_h                          00000060
tblval_l                          0000005F
tick_counter                      00000063
tick_counter_period               0000001C
timer1_h                          0000003F
timer1_l                          00000040
topmenu                           00000820
topmenu_h                         00000008
topmenu_l                         00000020
true                              0xFF
tu_demod_data                     00000047
tu_demod_data_full                00000048
tu_demod_shift                    00000046
tu_lock                           00000049
tu_lock_state                     0000004A
tu_lock_timer                     00000062
tu_mod_buffer                     000000C0
tu_mod_data                       00000041
tu_mod_data_full                  00000042
tu_mod_shift                      00000045
tuchar1                           0000004B
tuchar2                           0000004C
tumb_read_pointer                 00000044
tumb_write_pointer                00000043
tx                                00000020
tx_bit                            0
uart_rx_bit                       7
uart_tx_bit                       6
usart_read_pointer                00000026
usart_rx_data                     00000021
usart_rx_data_full                00000022
usart_tx_buffer                   000000B0
usart_tx_data                     00000023
usart_tx_data_full                00000024
usart_write_pointer               00000025
usartchar1                        00000027
usartchar2                        00000028
usingdebugger                     false
versionstr                        00000800
versionstr_h                      00000008
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 83


SYMBOL TABLE
  LABEL                             VALUE 

versionstr_l                      00000000
welstr                            00000815
welstr_h                          00000008
welstr_l                          00000015


MEMORY USAGE MAP ('X' = Used,  '-' = Unused)

0000 : X---XXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0040 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0080 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
00C0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0100 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0140 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0180 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
01C0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0200 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0240 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0280 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
02C0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0300 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0340 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0380 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
03C0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0400 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0440 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0480 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
04C0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0500 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0540 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0580 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
05C0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0600 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0640 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0680 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
06C0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXX-------- ----------------
0800 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0840 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0880 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
08C0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0900 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0940 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0980 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
09C0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0A00 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0A40 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
MPASM  5.43                         CREED.ASM   6-3-2014  15:52:35         PAGE 84


MEMORY USAGE MAP ('X' = Used,  '-' = Unused)


0A80 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0AC0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XX-------------- ----------------
2000 : -------X-------- ---------------- ---------------- ----------------
2100 : XXXXXXX--------- ---------------- ---------------- ----------------

All other memory blocks unused.

Program Memory Words Used:  2503
Program Memory Words Free:  5689


Errors   :     0
Warnings :     4 reported,     0 suppressed
Messages :     0 reported,    73 suppressed

